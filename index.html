<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Absensi Sekolah Online</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        /* Custom config for Tailwind */
        :root {
            --color-primary-light: 124 58 237; /* Violet 600 */
            --color-primary-base: 79 70 229;  /* Indigo 700 */
            --color-primary-dark: 67 56 202; /* Indigo 800 */
        }
        
        body {
            font-family: 'Inter', system-ui, Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Latar belakang yang lebih hidup */
            background: linear-gradient(135deg, #4c1d95 0%, #1e40af 100%); 
        }

        /* Glassmorphism Card Effect yang Ditingkatkan */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
        }
        
        .text-primary { color: rgb(var(--color-primary-base)); }
        .bg-primary { background-color: rgb(var(--color-primary-base)); }
        .hover\:bg-primary-dark:hover { background-color: rgb(var(--color-primary-dark)); }
        .focus\:border-primary:focus { border-color: rgb(var(--color-primary-base)); }
        
        /* Gaya Tombol Aksi Utama */
        .primary-btn {
            background-color: rgb(var(--color-primary-base));
            box-shadow: 0 4px 15px rgba(var(--color-primary-base), 0.5);
        }
        .primary-btn:hover {
            background-color: rgb(var(--color-primary-dark));
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(var(--color-primary-base), 0.6);
        }

        /* Custom scrollbar for log list */
        #attendance-log, #all-attendance-list {
            max-height: 350px; /* Diperpanjang sedikit */
            overflow-y: auto;
            border-radius: 12px;
        }

        /* Full screen wrapper for centering */
        .wrap {
            width: 100%;
            padding: 1.5rem;
            max-width: 1100px; /* Lebih lebar untuk admin view */
        }
        
        /* Ensure responsive grid in admin view */
        .admin-grid {
            display: grid;
            gap: 2rem; /* Jarak lebih besar */
            grid-template-columns: 1fr;
        }

        @media (min-width: 1024px) {
            .admin-grid {
                grid-template-columns: 1fr 2fr; /* Layout admin: Kontrol (1) & Log (2) */
            }
        }
        
        /* Gaya untuk Status Loading Global */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay (untuk mengatasi UI hilang saat inisialisasi) -->
    <div id="loading-overlay" class="opacity-100">
        <div class="flex flex-col items-center p-8 bg-white rounded-xl shadow-2xl">
            <i data-lucide="zap" class="w-10 h-10 animate-pulse text-primary mb-3"></i>
            <p class="text-lg font-semibold text-gray-700">Memuat Sistem...</p>
        </div>
    </div>

    <div class="wrap">
        <!-- Main Card Container -->
        <div class="glass-card w-full p-6 md:p-10 rounded-3xl transition-shadow duration-300" id="app-container">
            
            <!-- Views Container (Controlled by JS) -->
            <div id="auth-view" class="max-w-md mx-auto hidden">
                <!-- Login View -->
                <div id="login-form-container" data-view="login">
                    <div class="text-center mb-8">
                        <i data-lucide="shield-check" class="w-12 h-12 text-primary mx-auto mb-3 p-2 bg-indigo-100 rounded-full shadow-lg"></i>
                        <h1 class="text-3xl font-extrabold text-gray-800 mb-1">Masuk Sistem Absensi</h1>
                        <p class="text-base text-gray-500">Gunakan NISN atau Email Anda.</p>
                    </div>

                    <form id="login-form" autocomplete="on">
                        <div class="mb-5">
                            <label for="login-identifier" class="block text-sm font-semibold text-gray-700 mb-2">NISN atau Email</label>
                            <input id="login-identifier" name="identifier" type="text" inputmode="email" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/50 transition duration-150" 
                                placeholder="NISN (10 digit) atau email" required />
                        </div>
                        <div class="mb-8">
                            <label for="login-password" class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                            <div class="relative">
                                <input id="login-password" name="password" type="password" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/50 transition duration-150 pr-12" 
                                    placeholder="Masukkan password Anda" required />
                                <button type="button" class="absolute right-0 top-0 mt-3.5 mr-3 text-gray-400 hover:text-gray-600 toggle-password" aria-pressed="false" title="Tampilkan password">
                                    <i data-lucide="eye" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                        <button id="login-btn" class="w-full primary-btn text-white font-bold py-3.5 rounded-xl transition duration-200 disabled:opacity-50" type="submit">
                            <i data-lucide="log-in" class="w-5 h-5 inline-block mr-2"></i> Masuk
                        </button>
                    </form>

                    <div class="text-center mt-6 text-sm">
                        <p class="text-gray-600 mb-3">Belum punya akun? <a href="#" id="show-signup-button" class="text-primary hover:underline font-semibold">Daftar Sekarang</a></p>
                        <a href="#" id="show-forgot-password-button" class="text-gray-500 hover:text-primary transition duration-150">Lupa Password?</a>
                    </div>
                </div>
                
                <!-- Signup View (Hidden by default) -->
                <div id="signup-form-container" data-view="signup" class="hidden">
                     <div class="text-center mb-8">
                        <i data-lucide="user-plus" class="w-12 h-12 text-green-600 mx-auto mb-3 p-2 bg-green-100 rounded-full shadow-lg"></i>
                        <h1 class="text-3xl font-extrabold text-gray-800 mb-1">Daftar Akun Baru</h1>
                        <p class="text-base text-gray-500">Hanya untuk siswa/staf terdaftar (gunakan email sekolah).</p>
                    </div>

                    <form id="signup-form">
                         <div class="mb-4">
                            <label for="signup-email" class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                            <input id="signup-email" type="email" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/50" placeholder="email@sekolah.id" required>
                        </div>
                        <div class="mb-4">
                            <label for="signup-password" class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                            <div class="relative">
                                <input id="signup-password" type="password" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/50 pr-12" placeholder="Minimal 6 karakter" required>
                                <button type="button" class="absolute right-0 top-0 mt-3.5 mr-3 text-gray-400 hover:text-gray-600 toggle-password" aria-pressed="false" title="Tampilkan password">
                                    <i data-lucide="eye" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                         <div class="mb-8">
                            <label for="signup-nisn" class="block text-sm font-semibold text-gray-700 mb-2">NISN (10 Digit)</label>
                            <input id="signup-nisn" type="text" inputmode="numeric" pattern="\d{10}" maxlength="10" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/50" placeholder="NISN Anda (contoh: 0012345678)" required>
                        </div>
                        <button id="signup-btn" type="submit" class="w-full bg-green-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-green-500/50 hover:bg-green-700 transition duration-200 disabled:opacity-50">
                            <i data-lucide="user-plus" class="w-5 h-5 inline-block mr-2"></i> Daftar & Lanjutkan
                        </button>
                    </form>
                    <div class="text-center mt-6">
                        <a href="#" id="back-to-login-button" class="text-primary hover:underline font-semibold text-sm">&larr; Kembali ke Login</a>
                    </div>
                </div>

                <!-- Forgot Password View (Hidden by default) -->
                <div id="forgot-password-form-container" data-view="forgotPassword" class="hidden">
                    <div class="text-center mb-8">
                        <i data-lucide="mail-check" class="w-12 h-12 text-orange-600 mx-auto mb-3 p-2 bg-orange-100 rounded-full shadow-lg"></i>
                        <h1 class="text-3xl font-extrabold text-gray-800 mb-1">Lupa Password</h1>
                        <p class="text-base text-gray-500">Masukkan email Anda untuk menerima link reset.</p>
                    </div>

                    <form id="forgot-password-form">
                        <div class="mb-8">
                            <label for="forgot-email" class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                            <input id="forgot-email" type="email" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/50" placeholder="email@sekolah.id" required>
                        </div>
                        <button id="forgot-password-btn" type="submit" class="w-full bg-orange-600 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-orange-500/50 hover:bg-orange-700 transition duration-200 disabled:opacity-50">
                            <i data-lucide="send" class="w-5 h-5 inline-block mr-2"></i> Kirim Link Reset
                        </button>
                    </form>
                     <div class="text-center mt-6">
                        <a href="#" class="text-primary hover:underline font-semibold text-sm back-to-login-button">&larr; Kembali ke Login</a>
                    </div>
                </div>
            </div>

            <!-- Home View (Student & Admin) -->
            <div id="signed-in-view" class="hidden">
                <header class="flex justify-between items-center pb-4 border-b border-indigo-200 mb-6">
                    <div class="flex items-center gap-4">
                        <!-- Tambahkan tombol untuk buka modal profil -->
                        <div id="avatar" class="w-14 h-14 rounded-full bg-indigo-500 flex items-center justify-center text-white text-xl font-bold border-4 border-white shadow-lg cursor-pointer hover:ring-2 ring-indigo-400 transition" title="Lihat Profil">
                            <i data-lucide="user" class="w-6 h-6 text-indigo-100"></i>
                        </div>
                        <div>
                            <div id="profile-name" class="font-extrabold text-gray-800 text-xl leading-tight">Selamat Datang!</div>
                            <div class="text-sm text-gray-500" id="profile-role"></div>
                        </div>
                    </div>
                    <button id="logout-btn" class="text-sm text-red-600 font-semibold px-4 py-2 rounded-xl border border-red-300 bg-red-50 hover:bg-red-100 transition duration-150 shadow-md flex items-center gap-1">
                        <i data-lucide="log-out" class="w-4 h-4"></i> Keluar
                    </button>
                </header>
                
                <!-- Student Dashboard -->
                <div id="student-dashboard" class="hidden">
                    <!-- Kartu Jam & Absensi dengan Estetika Lebih Baik -->
                    <div class="bg-primary p-6 rounded-2xl shadow-xl shadow-indigo-600/50 text-white mb-10" aria-live="polite">
                        <div class="flex flex-col items-center justify-center border-b border-indigo-400/50 pb-4 mb-4">
                            <div class="text-5xl font-extrabold tracking-tight" id="clock">00:00:00</div>
                            <div class="text-base opacity-90 font-medium" id="date">-</div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 pt-2">
                            <button id="checkin" class="flex items-center justify-center bg-green-500/95 text-white font-extrabold py-4 rounded-xl hover:bg-green-600 shadow-xl shadow-green-500/30 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.01]">
                                <i data-lucide="arrow-down-left" class="w-5 h-5 mr-2"></i> Absen Masuk
                            </button>
                            <button id="checkout" class="flex items-center justify-center bg-red-500/95 text-white font-extrabold py-4 rounded-xl hover:bg-red-600 shadow-xl shadow-red-500/30 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-[1.01]">
                                <i data-lucide="arrow-up-right" class="w-5 h-5 mr-2"></i> Absen Pulang
                            </button>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <i data-lucide="history" class="w-5 h-5 text-indigo-500"></i> Riwayat Absensi Anda Hari Ini
                    </h3>
                    <div id="attendance-log" class="space-y-4">
                        <!-- Log entries will be inserted here -->
                    </div>
                </div>

                <!-- Admin/Teacher Dashboard -->
                <div id="admin-dashboard" class="hidden">
                    <div class="admin-grid">
                        <!-- Left Panel: Summary & Filters -->
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-xl">
                            <h2 class="text-xl font-extrabold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2 border-gray-100">
                                <i data-lucide="layout-dashboard" class="w-5 h-5 text-primary"></i> Kontrol Admin
                            </h2>
                            
                            <div class="space-y-6">
                                <div>
                                    <label for="attendance-date-filter" class="block text-sm font-semibold text-gray-700 mb-2">Pilih Tanggal Absensi</label>
                                    <input type="date" id="attendance-date-filter" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/50 transition duration-150 shadow-sm" required>
                                </div>
                                <div>
                                    <label for="search-student-input" class="block text-sm font-semibold text-gray-700 mb-2">Cari Siswa/NISN</label>
                                    <div class="relative">
                                        <i data-lucide="search" class="w-5 h-5 absolute left-3 top-3.5 text-gray-400"></i>
                                        <input type="text" id="search-student-input" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/50 transition duration-150 shadow-sm" placeholder="Nama atau NISN">
                                    </div>
                                </div>
                            </div>

                            <div class="mt-8">
                                <h3 class="font-bold text-lg text-gray-700 mb-3 border-b pb-1 border-gray-100">Statistik Hari Ini</h3>
                                <div id="summary-stats" class="grid grid-cols-2 gap-4">
                                    <!-- Stats will be inserted here -->
                                </div>
                            </div>
                        </div>

                        <!-- Right Panel: Log List -->
                        <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-xl">
                             <h2 class="text-xl font-extrabold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2 border-gray-100">
                                <i data-lucide="clipboard-list" class="w-5 h-5 text-primary"></i> Log Absensi Lengkap (<span id="log-date-display">...</span>)
                            </h2>
                            <div id="all-attendance-list" class="space-y-3">
                                <div class="text-sm text-center text-gray-500 p-6 bg-gray-50 border border-dashed border-gray-300 rounded-xl">Memuat data absensi...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Global Messages/Alerts -->
            <div id="messages" class="fixed bottom-4 right-4 z-50 p-4 rounded-xl shadow-2xl text-white font-medium transition-all duration-300 min-w-[250px] transform translate-y-20 opacity-0" role="alert"></div>
            
            <footer class="text-center text-xs text-gray-400 mt-10">
                Sistem Absensi Digital â€” Dibuat dengan Supabase & Tailwind CSS
            </footer>
        </div>
    </div>

    <script>
        // ---------- Supabase Config & Initialization ----------
        const SUPABASE_URL = 'https://qvunfkabbhulwqfnkren.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2dW5ma2FiYmh1bHdxZm5rcmVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNzkyOTksImV4cCI6MjA3NDg1NTI5OX0.2x_cwD11T4birj0NnAqzCqS_AtfZLqr65yb7ioV04IY'; 
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // ----------------------------------------------------

        // --- Global State and UI Elements ---
        const UIElements = {
            appContainer: document.getElementById('app-container'),
            loadingOverlay: document.getElementById('loading-overlay'),
            authView: document.getElementById('auth-view'),
            signedInView: document.getElementById('signed-in-view'),
            messages: document.getElementById('messages'),
            
            // Auth Views
            loginContainer: document.getElementById('login-form-container'),
            signupContainer: document.getElementById('signup-form-container'),
            forgotPasswordContainer: document.getElementById('forgot-password-form-container'),
            
            // Forms
            loginForm: document.getElementById('login-form'),
            signupForm: document.getElementById('signup-form'),
            forgotPasswordForm: document.getElementById('forgot-password-form'),
            
            // Student
            studentDashboard: document.getElementById('student-dashboard'),
            attendanceLog: document.getElementById('attendance-log'),
            checkinBtn: document.getElementById('checkin'),
            checkoutBtn: document.getElementById('checkout'),
            clockEl: document.getElementById('clock'),
            dateEl: document.getElementById('date'),
            
            // Admin
            adminDashboard: document.getElementById('admin-dashboard'),
            dateFilter: document.getElementById('attendance-date-filter'),
            searchStudentInput: document.getElementById('search-student-input'),
            allAttendanceList: document.getElementById('all-attendance-list'),
            summaryStats: document.getElementById('summary-stats'),
            logDateDisplay: document.getElementById('log-date-display'),
        };

        let messageTimeout;
        let currentUserProfile = null; // Store full user profile

        // --- Utility Functions ---
        
        function showMessage(msg, type = 'info') {
            clearTimeout(messageTimeout);
            
            UIElements.messages.textContent = msg;
            UIElements.messages.classList.remove('hidden', 'bg-red-600', 'bg-green-600', 'bg-indigo-600', 'bg-yellow-600', 'translate-y-20', 'opacity-0');
            UIElements.messages.classList.add('opacity-100', 'translate-y-0');

            if (type === 'error') {
                UIElements.messages.classList.add('bg-red-600');
            } else if (type === 'success') {
                UIElements.messages.classList.add('bg-green-600');
            } else if (type === 'warning') {
                UIElements.messages.classList.add('bg-yellow-600');
            } else {
                UIElements.messages.classList.add('bg-indigo-600');
            }

            // Hide after 5 seconds
            messageTimeout = setTimeout(() => { 
                UIElements.messages.classList.remove('opacity-100', 'translate-y-0'); 
                UIElements.messages.classList.add('opacity-0', 'translate-y-20');
                // Hapus kelas warna setelah transisi selesai
                setTimeout(() => { 
                    UIElements.messages.classList.add('hidden'); 
                    UIElements.messages.classList.remove('bg-red-600', 'bg-green-600', 'bg-indigo-600', 'bg-yellow-600');
                }, 300);
            }, 5000);
        }

        function updateClock() {
            const now = new Date();
            UIElements.clockEl.textContent = now.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            UIElements.dateEl.textContent = now.toLocaleDateString('id-ID', options);
        }

        function todayISO() { return new Date().toISOString().slice(0,10); }

        function formatTime(timeStr) {
            try {
                const parts = timeStr.split(':');
                if (parts.length >= 2) return `${parts[0]}:${parts[1]}`;
            } catch (e) {
                return timeStr;
            }
            return timeStr;
        }

        function getInitials(fullName) {
            if (!fullName) return '?';
            const parts = fullName.split(' ');
            if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
            return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
        }
        
        function getStatusClasses(status) {
            if (status.includes('Tepat Waktu') || status.includes('Tepat')) {
                return { class: 'text-green-700 bg-green-100', icon: 'check-circle' };
            } else if (status.includes('Terlambat')) {
                return { class: 'text-yellow-700 bg-yellow-100', icon: 'alert-circle' };
            } else if (status.includes('Pulang Lebih Awal')) {
                 return { class: 'text-red-700 bg-red-100', icon: 'x-circle' };
            } else {
                 return { class: 'text-gray-700 bg-gray-100', icon: 'info' };
            }
        }

        function showAuthView(viewName) {
            [UIElements.loginContainer, UIElements.signupContainer, UIElements.forgotPasswordContainer].forEach(container => {
                container.classList.add('hidden');
            });
            
            if (viewName === 'signup') {
                UIElements.signupContainer.classList.remove('hidden');
            } else if (viewName === 'forgotPassword') {
                UIElements.forgotPasswordContainer.classList.remove('hidden');
            } else { // default to login
                UIElements.loginContainer.classList.remove('hidden');
            }
            UIElements.authView.classList.remove('hidden');
            UIElements.signedInView.classList.add('hidden');
        }

        function hideLoadingOverlay() {
            UIElements.loadingOverlay.classList.remove('opacity-100');
            UIElements.loadingOverlay.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => { UIElements.loadingOverlay.classList.add('hidden'); UIElements.appContainer.classList.remove('hidden'); }, 300);
        }

        // --- Auth Logic ---
        async function signInWithIdentifier(identifier, password) {
            if (!identifier) throw new Error('Masukkan NISN/Email.');
            if (!password) throw new Error('Masukkan password.');
            
            // 1. Email path
            if (identifier.includes('@')) {
                const { data, error } = await supabase.auth.signInWithPassword({ email: identifier, password });
                if (error) throw error;
                return data;
            }

            // 2. NISN path (10 digits)
            const nisn = identifier.trim();
            if (!/^\d{10}$/.test(nisn)) throw new Error('NISN harus 10 digit atau gunakan format email yang valid.');
            
            // Lookup email by NISN in 'profiles' table
            const { data: prof, error: pErr } = await supabase.from('profiles').select('email').eq('nisn', nisn).maybeSingle();
            
            if (pErr) console.error("NISN lookup error:", pErr);
            if (!prof?.email) throw new Error('NISN tidak ditemukan atau tidak terhubung dengan akun.');
            
            // Use the found email to sign in
            const { data, error } = await supabase.auth.signInWithPassword({ email: prof.email, password });
            if (error) throw error;
            return data;
        }

        async function refreshProfile(user_id) {
            if (!user_id) return null;
            
            // Fetch profile data (full_name, role, nisn, etc.)
            const { data: profile, error } = await supabase.from('profiles')
                .select('id,full_name,email,avatar_url,nisn,role')
                .eq('id', user_id)
                .maybeSingle();
            
            if (error) console.warn('Gagal memuat profil', error);
            currentUserProfile = profile; // Update global state
            return profile;
        }

        // --- Rendering & Dashboard Logic ---
        async function renderDashboard(user) {
            const profile = await refreshProfile(user.id);
            if (!profile) return;
            
            UIElements.authView.classList.add('hidden');
            UIElements.signedInView.classList.remove('hidden');
            
            // Update profile info
            const name = profile.full_name || profile.nisn || (user.email || 'Pengguna');
            document.getElementById('profile-name').textContent = name;
            document.getElementById('profile-role').textContent = profile.role === 'admin' ? 'Guru / Admin' : `Siswa (${profile.nisn || '-'})`;

            // Update avatar
            const avatarEl = document.getElementById('avatar');
            avatarEl.innerHTML = profile.avatar_url ? '' : getInitials(name);
            avatarEl.style.backgroundColor = profile.avatar_url ? 'transparent' : '#4f46e5';
            avatarEl.style.backgroundImage = profile.avatar_url ? `url(${profile.avatar_url})` : 'none';
            avatarEl.classList.toggle('text-white', !profile.avatar_url);
            avatarEl.style.backgroundSize = 'cover';
            avatarEl.style.backgroundPosition = 'center';

            // Check Role and show appropriate dashboard
            if (profile.role === 'admin') {
                UIElements.studentDashboard.classList.add('hidden');
                UIElements.adminDashboard.classList.remove('hidden');
                
                // Initialize admin view
                UIElements.dateFilter.value = todayISO();
                await renderAllAttendanceLog(UIElements.dateFilter.value);
            } else {
                UIElements.adminDashboard.classList.add('hidden');
                UIElements.studentDashboard.classList.remove('hidden');
                
                // Initialize student view
                await loadTodayAttendance(user.id);
            }
            
            window.lucide.createIcons();
            hideLoadingOverlay();
        }

        // --- Student Attendance Functions ---

        function createAttendanceRow(record, includeName = false) {
            const typeText = record.type === 'check_in' ? 'Masuk' : 'Pulang';
            const { class: statusClass, icon: statusIcon } = getStatusClasses(record.status);
            const timeFormatted = formatTime(record.log_time);

            let profileInfo = '';
            if (includeName && record.profiles) {
                const p = record.profiles;
                const name = p.full_name || p.nisn;
                profileInfo = `<div class="font-bold text-base text-gray-800">${name}</div><div class="text-xs text-gray-500">NISN: ${p.nisn || '-'}</div>`;
            } else {
                profileInfo = `<div class="font-bold text-gray-800">${typeText}</div><div class="text-xs text-gray-500">${timeFormatted}</div>`;
            }

            return `
                <div class="flex items-center justify-between p-4 rounded-xl border border-gray-100 bg-white shadow-md hover:shadow-lg transition duration-150">
                    <div class="flex items-center gap-4">
                        <div class="p-2 rounded-full ${record.type === 'check_in' ? 'bg-indigo-100 text-indigo-600' : 'bg-pink-100 text-pink-600'}">
                            <i data-lucide="${record.type === 'check_in' ? 'arrow-down-left' : 'arrow-up-right'}" class="w-5 h-5"></i>
                        </div>
                        <div>${profileInfo}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-medium px-3 py-1.5 rounded-full ${statusClass} flex items-center gap-1">
                             <i data-lucide="${statusIcon}" class="w-4 h-4"></i>
                            ${record.status}
                        </span>
                    </div>
                </div>
            `;
        }


        async function loadTodayAttendance(user_id) {
            UIElements.attendanceLog.innerHTML = '';
            try {
                const { data, error } = await supabase.from('attendance_log')
                    .select('*')
                    .eq('user_id', user_id)
                    .eq('log_date', todayISO())
                    .order('log_time', { ascending: false }); // Urutkan terbaru di atas
                
                if (error) { console.error(error); showMessage('Gagal memuat absensi', 'error'); return; }

                if (!data || data.length === 0) {
                    UIElements.attendanceLog.innerHTML = '<div class="text-sm text-center text-gray-500 p-6 bg-gray-50 border border-dashed border-gray-300 rounded-xl">Absensi Anda hari ini masih kosong. Silakan Absen Masuk.</div>';
                    // Check logic: Can check in if no check-in record exists for today
                    const hasIn = data.some(x => x.type === 'check_in');
                    const hasOut = data.some(x => x.type === 'check_out');

                    UIElements.checkinBtn.disabled = hasIn;
                    UIElements.checkoutBtn.disabled = (!hasIn) || hasOut;

                } else {
                    data.forEach(r => { 
                        UIElements.attendanceLog.innerHTML += createAttendanceRow(r);
                    });
                    
                    window.lucide.createIcons();
                    
                    const hasIn = data.some(x => x.type === 'check_in');
                    const hasOut = data.some(x => x.type === 'check_out');
                    
                    UIElements.checkinBtn.disabled = hasIn;
                    UIElements.checkoutBtn.disabled = (!hasIn) || hasOut;
                }
            } catch (err) {
                console.error(err);
                showMessage('Terjadi kesalahan saat memuat absensi', 'error');
            }
        }

        async function doAttendance(type) {
            const btn = type === 'check_in' ? UIElements.checkinBtn : UIElements.checkoutBtn;
            btn.disabled = true;
            try {
                const { data: sessionData } = await supabase.auth.getSession();
                const user = sessionData?.session?.user;
                if (!user) { showMessage('Anda harus login', 'error'); return; }

                const now = new Date();
                let status = '';
                
                // Waktu batas di WIB (UTC+7)
                const checkinLimitHour = 7;
                const checkinLimitMinute = 15;
                const checkoutLimitHour = 15;
                const checkoutLimitMinute = 0;
                
                // Ambil jam dan menit saat ini
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();

                if (type === 'check_in') {
                    // Cek Terlambat: Jika jam > 7, ATAU jam == 7 dan menit > 15
                    if (currentHour > checkinLimitHour || (currentHour === checkinLimitHour && currentMinute > checkinLimitMinute)) {
                        status = 'Terlambat';
                    } else {
                        status = 'Tepat Waktu';
                    }
                } else { // check_out
                    // Cek Pulang Lebih Awal: Jika jam < 15, ATAU jam == 15 dan menit < 00
                    if (currentHour < checkoutLimitHour || (currentHour === checkoutLimitHour && currentMinute < checkoutLimitMinute)) {
                        status = 'Pulang Lebih Awal';
                    } else {
                        status = 'Pulang Tepat Waktu';
                    }
                }

                // Log time in 'HH:MM:SS' format
                const logTime = now.toLocaleTimeString('en-US', { hour12: false, hour:'2-digit', minute:'2-digit', second:'2-digit' }); 

                const record = { user_id: user.id, type, status, log_time: logTime, log_date: todayISO() };
                
                const { error } = await supabase.from('attendance_log').insert(record);
                
                if (error) throw error;
                
                showMessage(`Absen ${type === 'check_in' ? 'Masuk' : 'Pulang'} tercatat: ${status}`, 'success');
                await loadTodayAttendance(user.id);

            } catch (err) {
                console.error(err);
                showMessage(err.message || 'Gagal mencatat absensi', 'error');
            } finally {
                // Tombol akan di-enable/disable lagi di loadTodayAttendance
            }
        }
        
        // --- Admin Functions ---
        async function renderAllAttendanceLog(dateFilter, searchFilter = '') {
            UIElements.allAttendanceList.innerHTML = '<div class="text-center py-4"><i data-lucide="loader-circle" class="w-6 h-6 animate-spin text-primary mx-auto"></i><p class="text-sm text-gray-500 mt-2">Memuat data...</p></div>';
            UIElements.summaryStats.innerHTML = '';
            
            const dateToFilter = dateFilter || todayISO();
            
            // Perbarui tampilan tanggal di header
            UIElements.logDateDisplay.textContent = new Date(dateToFilter).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});

            let query = supabase.from('attendance_log')
                .select(`*, profiles:user_id(full_name, nisn)`)
                .eq('log_date', dateToFilter)
                .order('log_time', { ascending: false });

            try {
                const { data: records, error } = await query;
                
                if (error) throw error;
                
                // In-memory filter for search (simulating complex query)
                let filteredRecords = records;
                if (searchFilter) {
                    const lowerSearch = searchFilter.toLowerCase();
                    filteredRecords = records.filter(record => {
                        const profile = record.profiles;
                        return profile && (
                            (profile.full_name && profile.full_name.toLowerCase().includes(lowerSearch)) ||
                            (profile.nisn && profile.nisn.includes(lowerSearch))
                        );
                    });
                }
                
                // Grouping and Statistics
                const summary = calculateSummary(filteredRecords, dateToFilter);
                renderSummaryStats(summary);

                UIElements.allAttendanceList.innerHTML = '';
                if (filteredRecords.length === 0) {
                    UIElements.allAttendanceList.innerHTML = `<div class="text-sm text-center text-gray-500 p-6 bg-gray-50 border border-dashed border-gray-300 rounded-xl">Tidak ada data absensi ditemukan untuk tanggal ini.</div>`;
                } else {
                    filteredRecords.forEach(r => {
                        // Tambahkan margin-bottom pada setiap baris untuk jarak yang lebih baik
                        UIElements.allAttendanceList.innerHTML += createAttendanceRow(r, true);
                    });
                }
                window.lucide.createIcons();

            } catch (err) {
                console.error('Error loading admin log:', err);
                UIElements.allAttendanceList.innerHTML = '<div class="text-sm text-center text-red-600 p-6 bg-red-50 border border-dashed border-red-300 rounded-xl">Gagal memuat log absensi. Cek konsol.</div>';
            }
        }
        
        function calculateSummary(records, date) {
            const totalCheckIn = records.filter(r => r.type === 'check_in').length;
            const totalCheckOut = records.filter(r => r.type === 'check_out').length;
            const totalLate = records.filter(r => r.type === 'check_in' && r.status === 'Terlambat').length;
            const totalEarlyOut = records.filter(r => r.type === 'check_out' && r.status === 'Pulang Lebih Awal').length;
            
            return { totalCheckIn, totalCheckOut, totalLate, totalEarlyOut, date };
        }
        
        function renderSummaryStats(summary) {
            const stats = [
                { label: 'Absen Masuk', value: summary.totalCheckIn, icon: 'user-check', color: 'green' },
                { label: 'Absen Pulang', value: summary.totalCheckOut, icon: 'user-x', color: 'red' },
                { label: 'Terlambat Masuk', value: summary.totalLate, icon: 'clock', color: 'yellow' },
                { label: 'Pulang Awal', value: summary.totalEarlyOut, icon: 'log-out', color: 'pink' },
            ];
            
            UIElements.summaryStats.innerHTML = stats.map(stat => `
                <div class="p-4 rounded-xl bg-${stat.color}-50 border border-${stat.color}-200 flex items-center gap-3 shadow-sm hover:shadow-md transition duration-150">
                    <i data-lucide="${stat.icon}" class="w-6 h-6 text-${stat.color}-600"></i>
                    <div>
                        <div class="text-xl font-extrabold text-gray-800">${stat.value}</div>
                        <div class="text-xs text-${stat.color}-700 font-medium">${stat.label}</div>
                    </div>
                </div>
            `).join('');
            
            window.lucide.createIcons();
        }

        // --- Event Listeners and Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            // Clock init
            updateClock();
            setInterval(updateClock, 1000);

            // --- Form Submissions ---
            UIElements.loginForm.addEventListener('submit', async (ev) => {
                ev.preventDefault();
                const btn = document.getElementById('login-btn');
                btn.disabled = true;
                btn.innerHTML = '<i data-lucide="loader-circle" class="w-5 h-5 inline-block mr-2 animate-spin"></i> Memproses...';
                
                const id = document.getElementById('login-identifier').value.trim();
                const pwd = document.getElementById('login-password').value;
                
                try {
                    await signInWithIdentifier(id, pwd);
                    showMessage('Sukses masuk! Memuat dashboard...', 'success');
                } catch (err) {
                    console.error('Login Error:', err);
                    const errorMessage = err.message.includes('Invalid login credentials') ? 'NISN/Email atau Password salah.' : (err.message || 'Gagal login. Cek kembali data Anda.');
                    showMessage(errorMessage, 'error');
                } finally { 
                    btn.disabled = false;
                    btn.innerHTML = '<i data-lucide="log-in" class="w-5 h-5 inline-block mr-2"></i> Masuk';
                    window.lucide.createIcons();
                }
            });

            UIElements.signupForm.addEventListener('submit', async (ev) => {
                ev.preventDefault();
                const btn = document.getElementById('signup-btn');
                btn.disabled = true;
                btn.innerHTML = '<i data-lucide="loader-circle" class="w-5 h-5 inline-block mr-2 animate-spin"></i> Mendaftar...';
                
                const email = document.getElementById('signup-email').value.trim();
                const password = document.getElementById('signup-password').value;
                const nisn = document.getElementById('signup-nisn').value.trim();

                try {
                    if (!email || !password || !/^\d{10}$/.test(nisn)) throw new Error('Data pendaftaran tidak lengkap/tidak valid.');

                    // 1. Check if NISN is already taken
                    const { count: nisnCount, error: checkError } = await supabase.from('profiles').select('nisn', { count: 'exact' }).eq('nisn', nisn);
                    if (checkError) throw checkError;
                    if (nisnCount > 0) throw new Error('NISN ini sudah terdaftar. Silakan hubungi admin.');
                    
                    // 2. Auth signup
                    const { data: authData, error: authError } = await supabase.auth.signUp({ email, password });
                    if (authError) throw authError;
                    
                    // 3. Create profile entry (default role: student)
                    if (authData.user) {
                       const { error: profileError } = await supabase.from('profiles').insert({ 
                           id: authData.user.id, 
                           email, 
                           full_name: `Siswa ${nisn}`, // Default name
                           nisn,
                           role: 'student'
                       });
                       if (profileError) throw profileError;
                    }
                    
                    showAuthView('login');
                    showMessage('Pendaftaran berhasil! Silakan cek email Anda untuk verifikasi (jika diaktifkan) dan coba login.', 'success');
                } catch (err) {
                    console.error('Signup Error:', err);
                    showMessage(err.message || 'Gagal mendaftar', 'error');
                } finally { 
                    btn.disabled = false; 
                    btn.innerHTML = '<i data-lucide="user-plus" class="w-5 h-5 inline-block mr-2"></i> Daftar & Lanjutkan';
                    window.lucide.createIcons();
                }
            });
            
             UIElements.forgotPasswordForm.addEventListener('submit', async (ev) => {
                ev.preventDefault();
                const btn = document.getElementById('forgot-password-btn');
                btn.disabled = true;
                btn.innerHTML = '<i data-lucide="loader-circle" class="w-5 h-5 inline-block mr-2 animate-spin"></i> Mengirim...';
                
                const email = document.getElementById('forgot-email').value.trim();
                try {
                    if (!email) throw new Error('Masukkan email Anda.');

                    // NOTE: Supabase call to send reset email
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin, // Gunakan halaman saat ini
                    });

                    if (error) throw error;

                    showMessage(`Link reset password telah dikirim ke ${email}. (Periksa folder spam Anda).`, 'info');
                    
                } catch (err) {
                    console.error('Forgot Password Error:', err);
                    showMessage(err.message || 'Gagal mengirim link reset.', 'error');
                } finally { 
                    btn.disabled = false;
                    btn.innerHTML = '<i data-lucide="send" class="w-5 h-5 inline-block mr-2"></i> Kirim Link Reset';
                    window.lucide.createIcons();
                }
            });


            // --- Student Actions ---
            UIElements.checkinBtn.addEventListener('click', () => doAttendance('check_in'));
            UIElements.checkoutBtn.addEventListener('click', () => doAttendance('check_out'));
            
            document.getElementById('logout-btn')?.addEventListener('click', async () => {
                await supabase.auth.signOut();
                // State akan dihandle oleh onAuthStateChange
            });
            
            // --- Admin Actions ---
            UIElements.dateFilter.addEventListener('change', (e) => {
                renderAllAttendanceLog(e.target.value, UIElements.searchStudentInput?.value || '');
            });
            
            UIElements.searchStudentInput?.addEventListener('input', (e) => {
                renderAllAttendanceLog(UIElements.dateFilter.value, e.target.value);
            });
            
            // --- UI Navigations ---
            document.getElementById('show-signup-button')?.addEventListener('click', (e) => { e.preventDefault(); showAuthView('signup'); });
            document.getElementById('show-forgot-password-button')?.addEventListener('click', (e) => { e.preventDefault(); showAuthView('forgotPassword'); });
            document.querySelectorAll('.back-to-login-button').forEach(btn => {
                btn.addEventListener('click', (e) => { e.preventDefault(); showAuthView('login'); });
            });
            
            // --- Password Toggle ---
            document.querySelectorAll('.toggle-password').forEach(btn => {
                btn.addEventListener('click', function() {
                    const input = this.parentElement.querySelector('input');
                    const icon = this.querySelector('i');
                    if (input && icon) {
                        const isPassword = input.type === 'password';
                        input.type = isPassword ? 'text' : 'password';
                        icon.setAttribute('data-lucide', isPassword ? 'eye-off' : 'eye');
                        window.lucide.createIcons();
                    }
                });
            });

            // --- Initial Session Check (PENTING untuk mengatasi UI hilang) ---
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (session?.user && (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED')) { 
                    await renderDashboard(session.user); 
                }
                else if (event === 'SIGNED_OUT' || event === 'USER_DELETED') {
                    showAuthView('login'); // Tampilkan login view
                    hideLoadingOverlay(); // Sembunyikan loading jika sign out
                } else if (event === 'INITIAL_SESSION') {
                    // Hanya perlu menunggu dan event SIGNED_IN/SIGNED_OUT akan terpicu
                    if (!session?.user) {
                        showAuthView('login');
                        hideLoadingOverlay();
                    }
                }
            });
            
            // Panggil lucide icons setelah DOM siap, sebelum hide overlay
            window.lucide.createIcons();
            
            // Trigger initial session check manually if onAuthStateChange hasn't fired yet (fallback)
            (async () => {
                 const { data: { session } } = await supabase.auth.getSession();
                 if (!session?.user) {
                     // Jika tidak ada sesi saat DOMContentLoaded, pastikan login view muncul
                     showAuthView('login');
                     hideLoadingOverlay();
                 }
                 // Jika ada sesi, onAuthStateChange akan memicu renderDashboard
            })();

        });
    </script>
</body>
</html>
