<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Sekolah Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <!-- Library untuk Crop/Rotate/Resize Gambar -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js" defer></script>
    
    <style>
        /* --- BASE STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        /* --- BACKGROUND ANIMATION --- */
        body::before {
            content: '';
            position: fixed;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: backgroundMove 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes backgroundMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }
        
        /* --- GLASSMORPHISM COMPONENT --- */
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37), inset 0 1px 0 0 rgba(255, 255, 255, 0.5);
            position: relative;
        }
        
        .glass-effect::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.6) 50%, transparent 100%);
        }
        
        /* --- TYPOGRAPHY --- */
        .gradient-text {
            background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 2px 10px rgba(255, 255, 255, 0.3));
        }
        
        /* --- BUTTONS --- */
        .btn-primary {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white; font-weight: 600;
            transition: all 0.3s ease;
            position: relative; overflow: hidden;
        }
        
        .btn-primary::before {
            content: ''; position: absolute;
            top: 50%; left: 50%; width: 0; height: 0;
            border-radius: 50%; background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s;
        }
        
        .btn-primary:hover::before { width: 300px; height: 300px; }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .btn-primary:active { transform: translateY(0); }

        .btn-secondary {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-secondary:hover { background: rgba(0, 0, 0, 0.3); }

        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3); color: #fee2e2;
        }
        .btn-danger:hover { background: rgba(239, 68, 68, 0.4); }

        .btn-warning-custom {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.3); color: #fef3c7;
            font-weight: 600; transition: all 0.3s ease;
        }
        .btn-warning-custom:hover { background: rgba(245, 158, 11, 0.4); }
        
        .btn-info-custom {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3); color: #dbeafe;
            font-weight: 600; transition: all 0.3s ease;
        }
        .btn-info-custom:hover { background: rgba(59, 130, 246, 0.4); }
        
        /* --- UTILITIES & ANIMATIONS --- */
        .spinner {
            width: 50px; height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: white; border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-slide-in { animation: slideIn 0.5s ease-out; }
        
        .card-hover { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover {
            transform: translateY(-8px) scale(1.01);
            box-shadow: 0 20px 40px rgba(255, 255, 255, 0.2), inset 0 2px 0 0 rgba(255, 255, 255, 0.6);
        }
        
        /* --- FORMS --- */
        input:focus, select:focus, textarea:focus {
            outline: none; background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1), inset 0 1px 0 0 rgba(255, 255, 255, 0.3);
        }
        
        input, select, textarea {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff; transition: all 0.3s ease;
        }
        
        input::placeholder, select option { color: rgba(255, 255, 255, 0.6); }
        
        /* --- BADGES --- */
        .status-badge {
            display: inline-block; padding: 0.25rem 0.75rem;
            border-radius: 9999px; font-size: 0.75rem; font-weight: 600;
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status-success { background: rgba(16, 185, 129, 0.2); color: #d1fae5; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); }
        .status-warning { background: rgba(245, 158, 11, 0.2); color: #fef3c7; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3); }
        .status-danger { background: rgba(239, 68, 68, 0.2); color: #fee2e2; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3); }
        .status-info { background: rgba(59, 130, 246, 0.2); color: #dbeafe; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3); }
        
        /* --- CLOCK --- */
        .clock-display {
            font-size: 3rem; font-weight: 800; letter-spacing: -0.02em;
            filter: drop-shadow(0 4px 20px rgba(255, 255, 255, 0.5));
        }
        @media (max-width: 768px) { .clock-display { font-size: 2rem; } }
        
        /* --- TABLES --- */
        table { border-collapse: separate; border-spacing: 0; }
        table thead tr th {
            position: sticky; top: 0;
            background: rgba(249, 250, 251, 0.15); backdrop-filter: blur(10px);
            z-index: 10; border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
        }
        tbody tr { transition: all 0.3s ease; background: rgba(255, 255, 255, 0.05); }
        tbody tr:hover { background: rgba(255, 255, 255, 0.15); transform: scale(1.01); }
        tbody td { border-bottom: 1px solid rgba(255, 255, 255, 0.1); color: white; }
        
        /* --- EDITABLE CELLS --- */
        [contenteditable="true"] { min-height: 2rem; padding: 0.5rem; transition: all 0.3s ease; }
        [contenteditable="true"]:focus {
            background: rgba(251, 191, 36, 0.2);
            outline: 2px solid rgba(245, 158, 11, 0.5); outline-offset: -2px;
            backdrop-filter: blur(10px);
        }
        
        .delete-class-btn {
            background-color: transparent; color: #fca5a5;
            padding: 0.25rem; border-radius: 0.375rem; transition: all 0.3s ease;
        }
        .delete-class-btn:hover {
            background: rgba(239, 68, 68, 0.15); color: #fee2e2; backdrop-filter: blur(10px);
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .float-animation { animation: float 3s ease-in-out infinite; }
        .login-container { animation: float 6s ease-in-out infinite; }
        
        #loading-screen {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            backdrop-filter: blur(20px);
        }
        
        .text-white-glass { color: rgba(255, 255, 255, 0.95); text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        
        select { background: rgba(255, 255, 255, 0.08); color: white; }
        select option { background: #667eea; color: white; }

        /* --- MODAL & CROPPER --- */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px);
            z-index: 5000; display: flex; align-items: center; justify-content: center;
        }
        .modal-content { z-index: 5001; max-width: 90%; width: 100%; }
        #cropper-modal-content { max-width: 600px; }
        #cropper-container { height: 400px; background-color: #111; }
        #cropper-container img { max-width: 100%; height: 100%; object-fit: contain; }

        /* --- TOAST --- */
        #toast { transition: opacity 0.3s ease, transform 0.3s ease; }
        .toast-progress {
            position: absolute; bottom: 0; left: 0;
            height: 5px; width: 100%;
            background-color: rgba(255, 255, 255, 0.4);
            animation: toastCountdown 5s linear forwards;
        }
        @keyframes toastCountdown { from { width: 100%; } to { width: 0%; } }
    </style>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://qvunfkabbhulwqfnkren.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2dW5ma2FiYmh1bHdxZm5rcmVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNzkyOTksImV4cCI6MjA3NDg1NTI5OX0.2x_cwD11T4birj0NnAqzCqS_AtfZLqr65yb7ioV04IY';
        const AVATAR_BUCKET = 'avatars';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- VALIDATOR ---
        const Validators = {
            email: (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email),
            nisn: (nisn) => /^\d{10}$/.test(nisn),
            password: (password) => password.length >= 8,
            notEmpty: (value) => value && value.trim().length > 0
        };

        const ValidationMessages = {
            email: 'Format email tidak valid',
            nisn: 'NISN harus 10 digit angka',
            password: 'Password minimal 8 karakter',
            required: 'Kolom ini wajib diisi'
        };
        
        // --- STATE MANAGEMENT ---
        let UIElements = {};
        let appState = {
            currentUser: null,
            profile: null,
            scheduleData: {},
            attendanceLogs: [],
            allAttendanceLogs: [],
            toastTimeout: null,
            attendanceSubscription: null,
            clockInterval: null,
            profileImageFile: null,
            profileImageToDelete: false,
            selectedAdminClassId: null,
            classList: [],
            cropperInstance: null,
        };

        // --- ERROR HANDLING ---
        class ErrorHandler {
            static handle(error, context = '') {
                console.error(`Error in ${context}:`, error);
                const msg = error.message || '';
                
                // Map common errors
                if (msg.includes('Invalid login') || msg.includes('invalid_grant')) return 'Email/NISN atau password salah.';
                if (msg.includes('Email not confirmed')) return 'Email belum diverifikasi. Cek inbox Anda.';
                if (msg.includes('already registered')) return 'Email sudah terdaftar';
                if (msg.includes('Failed to fetch')) return 'Gagal terhubung ke server';
                if (error.code === 'PGRST116') return 'Data tidak ditemukan';
                if (error.code === '23503') return 'Tidak dapat menghapus data karena masih ada relasi.';
                if (msg.includes('profiles_nisn_key')) return 'NISN sudah terdaftar';
                if (msg.includes('classes_class_name_key')) return 'Nama kelas sudah ada.';
                if (msg.includes('Bucket not found')) return `Bucket '${AVATAR_BUCKET}' tidak ditemukan.`;

                return msg || `Terjadi kesalahan saat ${context}`;
            }
        }
        
        // --- UI UTILITIES ---
        function showLoading(isLoading) { 
            if (UIElements.loadingScreen) UIElements.loadingScreen.classList.toggle('hidden', !isLoading); 
        }

        function showToast(message, type = 'success') {
            if (!UIElements.toast) return;
            clearTimeout(appState.toastTimeout);
            
            const config = {
                success: { icon: 'check-circle', color: 'bg-emerald-500' },
                error: { icon: 'alert-circle', color: 'bg-red-500' },
                info: { icon: 'info', color: 'bg-blue-500' }
            };
            const theme = config[type] || config.success;

            UIElements.toast.className = `fixed bottom-6 right-6 ${theme.color} text-white rounded-xl shadow-2xl z-[6000] transition-all duration-300 overflow-hidden`;
            UIElements.toast.innerHTML = `
                <div class="flex items-center gap-3 py-4 px-6 min-w-[300px]">
                    <i data-lucide="${theme.icon}" class="w-5 h-5"></i><span>${message}</span>
                </div>
                <div class="toast-progress"></div>
            `;
            
            UIElements.toast.style.opacity = 1;
            UIElements.toast.style.transform = 'translateY(0)';
            lucide.createIcons();
            
            appState.toastTimeout = setTimeout(() => {
                if (UIElements.toast) {
                    UIElements.toast.style.opacity = 0;
                    UIElements.toast.style.transform = 'translateY(10px)';
                }
            }, 5000);
        }

        function navigateTo(view) {
            UIElements.loginPage?.classList.add('hidden');
            UIElements.mainApp?.classList.add('hidden');
            
            if (view === 'login') {
                UIElements.loginPage?.classList.remove('hidden');
            } else if (view === 'app') {
                UIElements.mainApp?.classList.remove('hidden');
                const isAdmin = appState.profile?.role === 'admin';
                UIElements.studentView?.classList.toggle('hidden', isAdmin);
                UIElements.adminView?.classList.toggle('hidden', !isAdmin);
            }
        }
        
        async function showAuthView(viewName) { 
            const views = { 
                login: UIElements.loginView, 
                signup: UIElements.signupView, 
                forgotPassword: UIElements.forgotPasswordView 
            };
            Object.values(views).forEach(v => v?.classList.add('hidden'));
            
            const targetView = views[viewName] || views.login;
            targetView?.classList.remove('hidden');
            targetView?.classList.add('animate-slide-in');

            if (viewName === 'signup') await populateSignupClassDropdown();
        }

        function updateClock() {
            if (!UIElements.clock || !UIElements.date) return;
            const now = new Date();
            const days = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            
            UIElements.clock.textContent = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            UIElements.date.textContent = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
            
            if (appState.profile?.role === 'student' && now.getSeconds() === 0) updateAttendanceButtons();
        }

        // --- HELPER FUNCTIONS ---
        const getInitials = (name) => {
            if (!name) return 'U';
            const parts = name.trim().split(' ');
            return parts.length === 1 ? parts[0][0].toUpperCase() : (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        };

        const generatePfpPlaceholder = (name) => 
            `https://placehold.co/100x100/FFFFFF/764ba2?text=${getInitials(name)}&font=inter`;

        function loadProfilePicture() {
            if (!appState.profile) return;
            const name = appState.profile.full_name || appState.profile.email.split('@')[0];
            const placeholder = generatePfpPlaceholder(name);
            const url = appState.profile.avatar_url 
                ? `${appState.profile.avatar_url}?t=${Date.now()}` 
                : placeholder;

            const setImg = (img) => {
                if (img) {
                    img.src = url;
                    img.onerror = () => { img.src = placeholder; };
                }
            };
            
            setImg(UIElements.headerPfp);
            setImg(UIElements.profileImagePreview);
        }

        // --- CORE APP LOGIC ---
        async function initializeMainApp(user) {
            appState.currentUser = user;
            showLoading(true);

            try {
                // Fetch Profile
                let { data: profile, error } = await supabase.from('profiles').select('*').eq('id', user.id).maybeSingle();
                
                // Create profile if missing
                if (!profile && !error) {
                    const meta = user.user_metadata || {};
                    const { data: newProfile, error: createError } = await supabase
                        .from('profiles')
                        .insert({
                            id: user.id,
                            email: user.email,
                            nisn: meta.nisn || localStorage.getItem(`pending_nisn_${user.id}`),
                            role: meta.role || 'student',
                            class_id: meta.class_id || localStorage.getItem(`pending_class_id_${user.id}`),
                            full_name: meta.full_name || user.email.split('@')[0]
                        })
                        .select().single();
                    
                    if (createError) throw createError;
                    profile = newProfile;
                    localStorage.removeItem(`pending_nisn_${user.id}`);
                    localStorage.removeItem(`pending_class_id_${user.id}`);
                } else if (error && error.code !== 'PGRST116') throw error;

                if (!profile) throw new Error("Gagal memuat profil.");

                // Get Class Info
                if (profile.class_id) {
                    const { data: cls } = await supabase.from('classes').select('class_name').eq('id', profile.class_id).maybeSingle();
                    if (cls) profile.classes = cls;
                }

                appState.profile = profile;
                UIElements.welcomeMessage.textContent = profile.full_name || profile.email;
                loadProfilePicture();
                populateProfileModal();

                // Role-based initialization
                if (profile.role === 'admin') {
                    await Promise.all([
                        fetchAllTodayAttendance().then(() => renderAllAttendanceLog()),
                        fetchClasses().then(() => { populateAdminClassesDropdown(); renderClassList(); })
                    ]);
                    subscribeToAttendanceChanges();
                    subscribeToClassChanges();
                } else {
                    await Promise.all([
                        fetchTodayAttendance().then(() => renderAttendanceLog()),
                        fetchSchedule().then(() => renderSchedule(UIElements.scheduleTableBody, false))
                    ]);
                    updateAttendanceButtons();
                }
                
                navigateTo('app');

            } catch (err) {
                showToast(ErrorHandler.handle(err, 'inisialisasi'), "error");
                setTimeout(handleLogout, 3000);
            } finally {
                showLoading(false);
            }
        }

        // --- DATA FETCHING & RENDERING ---
        
        async function fetchClasses() {
            const { data, error } = await supabase.from('classes').select('id, class_name').order('class_name');
            if (error) throw error;
            appState.classList = data || [];
        }

        function populateAdminClassesDropdown() {
            if (!UIElements.adminClassSelect) return;
            const options = ['<option value="" disabled selected>Pilih kelas...</option>', 
                ...appState.classList.map(c => `<option value="${c.id}">${c.class_name}</option>`)
            ].join('');
            UIElements.adminClassSelect.innerHTML = options;
            UIElements.adminClassSelect.value = "";
            appState.selectedAdminClassId = null;
            UIElements.adminScheduleContainer?.classList.add('hidden');
        }

        async function populateSignupClassDropdown() {
            if (!UIElements.signupClassSelect) return;
            if (!appState.classList.length) await fetchClasses().catch(() => {});
            
            const options = appState.classList.length 
                ? appState.classList.map(c => `<option value="${c.id}">${c.class_name}</option>`).join('')
                : '<option value="" disabled>Belum ada kelas</option>';
                
            UIElements.signupClassSelect.innerHTML = `<option value="" disabled selected>Pilih kelas Anda...</option>${options}`;
        }

        async function fetchSchedule() {
            if (!appState.profile.class_id) return;
            const { data } = await supabase.from('schedules').select('data').eq('class_id', appState.profile.class_id).maybeSingle();
            appState.scheduleData = data?.data || {};
        }

        function renderSchedule(tbody, isEditable) {
            if (!tbody) return;
            tbody.innerHTML = '';
            
            const days = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat"];
            const times = ["06:30-07:15", "07:15-08:00", "08:00-08:45", "08:45-09:30", "09:30-9:45", "9:45:00-10:30", "10:30-11:15", "11:15-12:00", "12:00-12:45", "12:45-13:30", "13:30-14:15", "14:15-15:00"];
            
            if (!Object.keys(appState.scheduleData || {}).length && !isEditable) {
                tbody.innerHTML = `<tr><td colspan="${days.length + 1}" class="text-center p-6 text-white-glass">Jadwal belum diatur</td></tr>`;
                return;
            }

            const todayIdx = new Date().getDay() - 1;
            const fragment = document.createDocumentFragment();

            times.forEach((time, tIdx) => {
                const tr = document.createElement('tr');
                let html = `<td class="p-3 font-semibold text-sm sticky left-0 z-10 text-white-glass" style="background:rgba(249,250,251,0.15);backdrop-filter:blur(10px);">${time}</td>`;
                
                days.forEach((day, dIdx) => {
                    const subject = appState.scheduleData?.[day]?.[tIdx] || '';
                    const isRest = subject.toLowerCase().includes('istirahat');
                    let cellClass = 'p-1 text-center text-sm border-l border-white/10 ';
                    let cellContent = '';

                    if (dIdx === todayIdx && !isEditable) {
                        cellClass += 'font-semibold ';
                        // Background handled via style
                    }
                    if (isRest) cellClass += 'italic text-white-glass ';

                    if (isEditable && !isRest) {
                        cellContent = `<input type="text" value="${subject}" class="w-full min-w-[100px] p-2 bg-transparent text-center text-white placeholder-white/50 focus:bg-yellow-500/20 focus:outline-none rounded border border-transparent focus:border-yellow-300 transition-all">`;
                    } else {
                        cellClass += isEditable ? 'text-white-glass ' : 'p-3 text-white-glass ';
                        cellContent = subject;
                    }

                    const bgStyle = (dIdx === todayIdx && !isEditable) ? 'background: rgba(139, 92, 246, 0.3);' : (isRest ? 'background: rgba(156, 163, 175, 0.2);' : '');
                    html += `<td class="${cellClass.trim()}" style="${bgStyle}">${cellContent}</td>`;
                });
                tr.innerHTML = html;
                fragment.appendChild(tr);
            });
            tbody.appendChild(fragment);
        }

        async function fetchTodayAttendance() {
            if (!appState.currentUser) return;
            const { data } = await supabase.from('attendance_log').select('*')
                .eq('user_id', appState.currentUser.id)
                .eq('log_date', new Date().toISOString().split('T')[0])
                .order('log_time', { ascending: false });
            appState.attendanceLogs = data || [];
        }

        function renderAttendanceLog() {
            if (!UIElements.attendanceLogList) return;
            UIElements.attendanceLogList.innerHTML = '';

            if (!appState.attendanceLogs.length) {
                UIElements.attendanceLogList.innerHTML = `<div class="text-center py-8"><i data-lucide="calendar-x" class="w-12 h-12 mx-auto text-white/30 mb-2"></i><p class="text-white-glass">Belum ada riwayat absensi hari ini</p></div>`;
                lucide.createIcons();
                return;
            }

            const fragment = document.createDocumentFragment();
            appState.attendanceLogs.forEach((log, i) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-4 rounded-lg glass-effect hover:bg-white/10 transition-colors animate-slide-in';
                div.style.animationDelay = `${i * 0.1}s`;
                
                let meta = { title: 'Log Absensi', icon: 'help-circle', class: 'status-warning' };
                if (log.type === 'check_in') {
                    meta = { title: 'Absen Masuk', icon: 'log-in', class: log.status.includes('Tepat') ? 'status-success' : 'status-danger' };
                } else if (log.type === 'check_out') {
                    meta = { title: 'Absen Pulang', icon: 'log-out', class: log.status.includes('Tepat') ? 'status-success' : 'status-danger' };
                } else if (log.status === 'Sakit') {
                    meta = { title: 'Keterangan Sakit', icon: 'thermometer', class: 'status-warning' };
                } else if (log.status === 'Izin') {
                    meta = { title: 'Keterangan Izin', icon: 'file-text', class: 'status-info' };
                }

                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full glass-effect flex items-center justify-center shadow"><i data-lucide="${meta.icon}" class="w-5 h-5 text-white"></i></div>
                        <div><p class="font-semibold text-white">${meta.title}</p><p class="text-sm text-white-glass">${log.log_time}</p></div>
                    </div>
                    <span class="status-badge ${meta.class}">${log.status}</span>
                `;
                fragment.appendChild(div);
            });
            UIElements.attendanceLogList.appendChild(fragment);
            lucide.createIcons();
        }

        function updateAttendanceButtons() {
            if (!UIElements.checkInButton) return;
            
            const logs = appState.attendanceLogs;
            const hasCheckIn = logs.some(l => l.type === 'check_in');
            const hasCheckOut = logs.some(l => l.type === 'check_out');
            const hasAbsence = logs.some(l => l.type === 'absence' || l.status === 'Sakit' || l.status === 'Izin');
            const hasDayLog = hasCheckIn || hasAbsence;

            // Helper to set button state
            const setBtn = (btn, disabled) => {
                btn.disabled = disabled;
                btn.classList.toggle('opacity-50', disabled);
                btn.classList.toggle('cursor-not-allowed', disabled);
            };

            setBtn(UIElements.checkInButton, hasDayLog);
            setBtn(UIElements.sakitButton, hasDayLog);
            setBtn(UIElements.izinButton, hasDayLog);
            setBtn(UIElements.checkOutButton, !hasCheckIn || hasCheckOut);
        }

        async function fetchAllTodayAttendance() {
            const { data } = await supabase
                .from('attendance_log')
                .select('*, profiles(*, classes(class_name))')
                .eq('log_date', new Date().toISOString().split('T')[0])
                .order('log_time', { ascending: false });
            appState.allAttendanceLogs = data || [];
        }

        function renderAllAttendanceLog(filter = '') {
            if (!UIElements.adminAttendanceLogBody) return;
            
            // Stats Calculation
            let stats = { tepat: 0, telat: 0, izin: 0, sakit: 0 };
            appState.allAttendanceLogs.forEach(l => {
                const s = l.status || '';
                if (s === 'Sakit') stats.sakit++;
                else if (s === 'Izin') stats.izin++;
                else if (s.includes('Tepat')) stats.tepat++;
                else if (s.includes('Telat')) stats.telat++;
            });
            
            if (UIElements.countTepat) {
                UIElements.countTepat.textContent = stats.tepat;
                UIElements.countTelat.textContent = stats.telat;
                UIElements.countIzin.textContent = stats.izin;
                UIElements.countSakit.textContent = stats.sakit;
            }

            // Rendering List
            UIElements.adminAttendanceLogBody.innerHTML = '';
            const term = filter.toLowerCase().trim();
            const filtered = appState.allAttendanceLogs.filter(l => {
                if (!l.profiles) return false;
                return (l.profiles.nisn || '').includes(term) || 
                       (l.profiles.email || '').toLowerCase().includes(term) || 
                       (l.profiles.classes?.class_name || '').toLowerCase().includes(term) ||
                       (l.profiles.full_name || '').toLowerCase().includes(term);
            });

            if (!filtered.length) {
                UIElements.adminAttendanceLogBody.innerHTML = `<tr><td colspan="6" class="text-center p-8"><i data-lucide="search-x" class="w-12 h-12 mx-auto text-white/30 mb-2"></i><p class="text-white-glass">Tidak ada data.</p></td></tr>`;
                lucide.createIcons();
                return;
            }

            const fragment = document.createDocumentFragment();
            filtered.forEach(log => {
                const row = document.createElement('tr');
                row.className = 'border-b border-white/10 hover:bg-white/10 transition-colors';
                
                let statusClass = 'status-warning';
                if (log.status.includes('Tepat')) statusClass = 'status-success';
                else if (log.status.includes('Telat') || log.status.includes('Awal')) statusClass = 'status-danger';
                else if (log.status === 'Izin') statusClass = 'status-info';

                let typeMap = { 'check_in': 'Masuk', 'check_out': 'Pulang', 'absence': 'Absen' };
                const displayType = typeMap[log.type] || log.type;

                row.innerHTML = `
                    <td class="p-3"><div class="font-semibold text-white">${log.profiles?.full_name || 'Tanpa Nama'}</div><div class="text-xs text-white-glass font-mono">${log.profiles?.nisn || '-'}</div></td>
                    <td class="p-3 text-sm text-white-glass">${log.profiles?.email || '-'}</td>
                    <td class="p-3"><span class="px-3 py-1 bg-purple-500/20 text-purple-200 rounded-full text-xs font-semibold border border-purple-300/30">${log.profiles?.classes?.class_name || '-'}</span></td>
                    <td class="p-3 text-sm text-white-glass">${displayType}</td>
                    <td class="p-3 font-semibold text-white">${log.log_time}</td>
                    <td class="p-3"><span class="status-badge ${statusClass}">${log.status}</span></td>
                `;
                fragment.appendChild(row);
            });
            UIElements.adminAttendanceLogBody.appendChild(fragment);
        }

        // --- EVENT HANDLERS ---

        async function handleLogin(e) {
            e.preventDefault();
            UIElements.loginError.classList.add('hidden');
            const fd = new FormData(e.target);
            const id = fd.get('identifier')?.trim();
            const pw = fd.get('password');

            if (!id || !pw) return showToast('Mohon isi semua kolom', 'error');
            showLoading(true);

            try {
                let email = id;
                if (!id.includes('@')) {
                    if (!Validators.nisn(id)) throw new Error('Format NISN salah (10 digit).');
                    const { data: p } = await supabase.from('profiles').select('email').eq('nisn', id).maybeSingle();
                    if (!p) throw new Error('NISN tidak ditemukan.');
                    email = p.email;
                }

                const { data, error } = await supabase.auth.signInWithPassword({ email, password: pw });
                if (error) throw error;
                await initializeMainApp(data.user);

            } catch (err) {
                const msg = ErrorHandler.handle(err, 'login');
                UIElements.loginError.innerHTML = `<i data-lucide="alert-circle" class="w-5 h-5"></i><span>${msg}</span>`;
                UIElements.loginError.classList.remove('hidden');
                lucide.createIcons();
            } finally { showLoading(false); }
        }

        async function handleSignUp(e) {
            e.preventDefault();
            UIElements.signupError.classList.add('hidden');
            const fd = new FormData(e.target);
            const data = Object.fromEntries(fd.entries());
            
            // Validation
            if (!Validators.email(data.email)) return showToast('Email tidak valid', 'error');
            if (!Validators.nisn(data.nisn)) return showToast('NISN harus 10 digit', 'error');
            if (!data.class_id) return showToast('Pilih kelas', 'error');
            if (data.password.length < 8) return showToast('Password min 8 karakter', 'error');

            showLoading(true);
            try {
                const { data: existing } = await supabase.from('profiles').select('id').eq('nisn', data.nisn).maybeSingle();
                if (existing) throw new Error('NISN sudah terdaftar.');

                const { data: res, error } = await supabase.auth.signUp({
                    email: data.email, password: data.password,
                    options: {
                        data: { nisn: data.nisn, role: 'student', class_id: data.class_id, full_name: data.full_name },
                        emailRedirectTo: window.location.href
                    }
                });

                if (error) throw error;
                
                showToast('Pendaftaran berhasil! Cek email untuk verifikasi.', 'info');
                if (!res.user.email_confirmed_at) {
                    localStorage.setItem(`pending_nisn_${res.user.id}`, data.nisn);
                    localStorage.setItem(`pending_class_id_${res.user.id}`, data.class_id);
                }
                e.target.reset();
                setTimeout(() => showAuthView('login'), 2000);

            } catch (err) {
                UIElements.signupError.innerHTML = `<i data-lucide="alert-circle" class="w-5 h-5"></i><span>${ErrorHandler.handle(err, 'sign up')}</span>`;
                UIElements.signupError.classList.remove('hidden');
                lucide.createIcons();
            } finally { showLoading(false); }
        }

        async function handleCommonAttendance(type, statusArg) {
            if (!appState.currentUser) return handleLogout();
            
            showLoading(true);
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-GB', { timeZone: 'Asia/Jakarta' }); // HH:mm:ss
            
            let status = statusArg;
            if (type === 'check_in') status = timeStr > "07:00:00" ? "Telat Masuk" : "Tepat Masuk";
            else if (type === 'check_out') status = timeStr < "15:00:00" ? "Pulang Awal" : "Tepat Pulang";

            try {
                const { error } = await supabase.from('attendance_log').insert({
                    user_id: appState.currentUser.id,
                    type: type,
                    log_date: now.toISOString().split('T')[0],
                    log_time: timeStr,
                    status: status
                });

                if (error) throw error;
                
                showToast('Berhasil direkam!', 'success');
                await fetchTodayAttendance();
                renderAttendanceLog();
            } catch (err) {
                const msg = err.message.includes('duplicate key') ? 'Anda sudah melakukan aksi ini hari ini.' : ErrorHandler.handle(err, 'absensi');
                showToast(msg, 'error');
            } finally {
                showLoading(false);
                updateAttendanceButtons();
            }
        }

        async function handleUpdateSchedule() {
            if (!appState.selectedAdminClassId) return showToast("Pilih kelas dulu", "error");
            
            UIElements.saveScheduleButton.disabled = true;
            showLoading(true);
            
            const newData = { Senin: [], Selasa: [], Rabu: [], Kamis: [], Jumat: [] };
            const days = Object.keys(newData);
            
            // Collect Data
            const rows = UIElements.adminScheduleTableBody.querySelectorAll('tr');
            let errorMsg = null;

            rows.forEach((row, rIdx) => {
                row.querySelectorAll('td:not(:first-child)').forEach((cell, cIdx) => {
                    const val = (cell.querySelector('input')?.value || cell.textContent).trim();
                    if (val.length > 50) errorMsg = `Teks terlalu panjang di baris ${rIdx+1}`;
                    newData[days[cIdx]].push(val);
                });
            });

            if (errorMsg) {
                showLoading(false);
                UIElements.saveScheduleButton.disabled = false;
                return showToast(errorMsg, 'error');
            }

            try {
                const { error } = await supabase.from('schedules').upsert({ class_id: appState.selectedAdminClassId, data: newData }, { onConflict: 'class_id' });
                if (error) throw error;
                showToast('Jadwal tersimpan!', 'success');
                appState.scheduleData = newData;
            } catch (err) {
                showToast(ErrorHandler.handle(err, 'simpan jadwal'), 'error');
            } finally {
                showLoading(false);
                UIElements.saveScheduleButton.disabled = false;
            }
        }

        async function handleAdminClassSelect(e) {
            const cid = e.target.value;
            appState.selectedAdminClassId = cid;
            appState.scheduleData = {};
            
            if (!cid) return UIElements.adminScheduleContainer?.classList.add('hidden');
            
            showLoading(true);
            try {
                const { data } = await supabase.from('schedules').select('data').eq('class_id', cid).maybeSingle();
                appState.scheduleData = data?.data || {};
                UIElements.adminScheduleContainer?.classList.remove('hidden');
                renderSchedule(UIElements.adminScheduleTableBody, true);
            } catch (err) { showToast(err.message, 'error'); } 
            finally { showLoading(false); }
        }

        // --- ADMIN CLASS MGMT ---
        async function handleAddClass(e) {
            e.preventDefault();
            const val = UIElements.newClassNameInput.value.trim();
            if (!val) return;

            showLoading(true);
            try {
                const { data, error } = await supabase.from('classes').insert({ class_name: val }).select().single();
                if (error) throw error;
                
                showToast(`Kelas ${val} ditambahkan`, 'success');
                appState.classList.push(data);
                appState.classList.sort((a,b) => a.class_name.localeCompare(b.class_name));
                
                renderClassList();
                populateAdminClassesDropdown();
                e.target.reset();
            } catch (err) { showToast(ErrorHandler.handle(err, 'tambah kelas'), 'error'); }
            finally { showLoading(false); }
        }

        async function handleDeleteClass(id, name) {
            if (!confirm(`Hapus kelas ${name}?`)) return;
            showLoading(true);
            try {
                const { error } = await supabase.from('classes').delete().eq('id', id);
                if (error) throw error;
                
                appState.classList = appState.classList.filter(c => c.id !== id);
                renderClassList();
                populateAdminClassesDropdown();
                showToast('Kelas dihapus', 'success');
            } catch (err) { showToast(ErrorHandler.handle(err, 'hapus kelas'), 'error'); }
            finally { showLoading(false); }
        }

        function renderClassList() {
            if (!UIElements.adminClassList) return;
            if (!appState.classList.length) {
                UIElements.adminClassList.innerHTML = '<li class="text-white-glass italic px-4 py-2">Kosong.</li>';
                return;
            }
            
            const fragment = document.createDocumentFragment();
            appState.classList.forEach(cls => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center px-4 py-3 border-b border-white/10';
                li.innerHTML = `<span class="text-white">${cls.class_name}</span><button class="delete-class-btn" data-id="${cls.id}" data-name="${cls.class_name}"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>`;
                li.querySelector('button').onclick = (e) => handleDeleteClass(e.target.dataset.id, e.target.dataset.name);
                fragment.appendChild(li);
            });
            UIElements.adminClassList.innerHTML = '';
            UIElements.adminClassList.appendChild(fragment);
            lucide.createIcons();
        }

        // --- PROFILE & IMAGE ---
        function openProfileModal() {
            if (!appState.profile) return;
            UIElements.profileFullName.value = appState.profile.full_name || '';
            UIElements.profileEmail.value = appState.profile.email || '';
            UIElements.profileNisn.value = appState.profile.nisn || '';
            loadProfilePicture();
            appState.profileImageFile = null;
            appState.profileImageToDelete = false;
            UIElements.profileModal.classList.remove('hidden');
        }

        async function handleUpdateProfile(e) {
            e.preventDefault();
            const newName = UIElements.profileFullName.value.trim();
            if (!newName) return showToast('Nama wajib diisi', 'error');

            showLoading(true);
            try {
                const updates = { full_name: newName };
                
                // Image Upload Logic
                if (appState.profileImageFile) {
                    const ext = appState.profileImageFile.type.split('/')[1];
                    const path = `public/${appState.currentUser.id}/avatar-${Date.now()}.${ext}`;
                    
                    const { data, error } = await supabase.storage.from(AVATAR_BUCKET).upload(path, appState.profileImageFile, { upsert: true });
                    if (error) throw error;
                    
                    const { data: urlData } = supabase.storage.from(AVATAR_BUCKET).getPublicUrl(data.path);
                    updates.avatar_url = urlData.publicUrl;

                    // Cleanup old
                    if (appState.profile.avatar_url) {
                        const oldPath = appState.profile.avatar_url.split(`/${AVATAR_BUCKET}/`)[1];
                        if (oldPath) supabase.storage.from(AVATAR_BUCKET).remove([oldPath.split('?')[0]]);
                    }
                } else if (appState.profileImageToDelete) {
                    updates.avatar_url = null;
                    // Cleanup old logic...
                }

                const { data: updated, error } = await supabase.from('profiles').update(updates).eq('id', appState.currentUser.id).select().single();
                if (error) throw error;

                appState.profile = updated;
                UIElements.welcomeMessage.textContent = updated.full_name;
                loadProfilePicture();
                showToast('Profil diperbarui', 'success');
                UIElements.profileModal.classList.add('hidden');

            } catch (err) { showToast(ErrorHandler.handle(err, 'update profil'), 'error'); }
            finally { showLoading(false); }
        }

        // --- INIT & LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            // Cache DOM Elements Map
            const idMap = [
                'loading-screen','toast','login-page','main-app','login-view','signup-view','forgot-password-view',
                'login-form','signup-form','forgot-password-form','login-error','signup-error','forgot-error',
                'welcome-message','header-pfp','profile-button','profile-dropdown','profile-modal-open-btn',
                'logout-button','profile-modal','close-profile-modal','profile-form','profile-full-name',
                'profile-email','profile-nisn','profile-image-preview','profile-image-input','profile-image-upload-btn',
                'remove-profile-image-btn','profile-save-btn','cropper-modal','cropper-image','cropper-apply-btn',
                'cropper-cancel-btn','cropper-rotate-left-btn','cropper-rotate-right-btn','student-view','admin-view',
                'clock','date','schedule-table-body','admin-schedule-table-body','attendance-log-list',
                'check-in-button','check-out-button','sakit-button','izin-button','save-schedule-button',
                'admin-attendance-log-body','refresh-attendance-button','search-student-input','admin-class-select',
                'admin-schedule-container','export-csv-button','signup-class-select','admin-class-list',
                'add-class-form','new-class-name','count-tepat','count-telat','count-izin','count-sakit'
            ];
            idMap.forEach(id => UIElements[id.replace(/-([a-z])/g, g => g[1].toUpperCase())] = document.getElementById(id)); // camelCase keys

            // Auth & Session Check
            (async () => {
                showLoading(true);
                const { data } = await supabase.auth.getSession();
                if (data.session?.user) await initializeMainApp(data.session.user);
                else navigateTo('login');
                showLoading(false);
            })();

            // Clock
            appState.clockInterval = setInterval(updateClock, 1000);
            updateClock();

            // Event Bindings
            UIElements.loginForm?.addEventListener('submit', handleLogin);
            UIElements.signupForm?.addEventListener('submit', handleSignUp);
            UIElements.logoutButton?.addEventListener('click', async () => {
                showLoading(true);
                await supabase.auth.signOut();
                if (appState.attendanceSubscription) supabase.removeChannel(appState.attendanceSubscription);
                window.location.reload(); // Cleanest logout
            });

            // Attendance Actions
            UIElements.checkInButton?.addEventListener('click', () => handleCommonAttendance('check_in'));
            UIElements.checkOutButton?.addEventListener('click', () => handleCommonAttendance('check_out'));
            UIElements.sakitButton?.addEventListener('click', () => handleCommonAttendance('absence', 'Sakit'));
            UIElements.izinButton?.addEventListener('click', () => handleCommonAttendance('absence', 'Izin'));

            // Nav Buttons
            document.getElementById('show-signup-button')?.addEventListener('click', () => showAuthView('signup'));
            document.getElementById('show-login-button')?.addEventListener('click', () => showAuthView('login'));
            document.getElementById('show-forgot-password-button')?.addEventListener('click', () => showAuthView('forgotPassword'));
            document.getElementById('back-to-login-button')?.addEventListener('click', () => showAuthView('login'));

            // Profile UI
            UIElements.profileButton?.addEventListener('click', (e) => { e.stopPropagation(); UIElements.profileDropdown.classList.toggle('hidden'); });
            document.addEventListener('click', () => UIElements.profileDropdown?.classList.add('hidden'));
            UIElements.profileModalOpenBtn?.addEventListener('click', openProfileModal);
            UIElements.closeProfileModal?.addEventListener('click', () => UIElements.profileModal.classList.add('hidden'));
            
            // Profile Image
            UIElements.profileImageUploadBtn?.addEventListener('click', () => UIElements.profileImageInput.click());
            UIElements.profileImageInput?.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        UIElements.cropperImage.src = ev.target.result;
                        UIElements.cropperModal.classList.remove('hidden');
                        if (appState.cropperInstance) appState.cropperInstance.destroy();
                        appState.cropperInstance = new Cropper(UIElements.cropperImage, { aspectRatio: 1, viewMode: 1 });
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Cropper Actions
            UIElements.cropperCancelBtn?.addEventListener('click', () => {
                UIElements.cropperModal.classList.add('hidden');
                UIElements.profileImageInput.value = '';
            });
            UIElements.cropperApplyBtn?.addEventListener('click', () => {
                appState.cropperInstance.getCroppedCanvas({ width: 512, height: 512 }).toBlob((blob) => {
                    appState.profileImageFile = blob;
                    UIElements.profileImagePreview.src = URL.createObjectURL(blob);
                    UIElements.cropperModal.classList.add('hidden');
                });
            });
            UIElements.cropperRotateLeftBtn?.addEventListener('click', () => appState.cropperInstance?.rotate(-90));
            UIElements.cropperRotateRightBtn?.addEventListener('click', () => appState.cropperInstance?.rotate(90));
            
            UIElements.profileForm?.addEventListener('submit', handleUpdateProfile);
            UIElements.removeProfileImageBtn?.addEventListener('click', () => {
                appState.profileImageFile = null;
                appState.profileImageToDelete = true;
                UIElements.profileImagePreview.src = generatePfpPlaceholder(appState.profile.full_name);
            });

            // Admin Actions
            UIElements.refreshAttendanceButton?.addEventListener('click', async () => {
                showLoading(true);
                await fetchAllTodayAttendance();
                renderAllAttendanceLog(UIElements.searchStudentInput?.value || '');
                showLoading(false);
            });
            UIElements.searchStudentInput?.addEventListener('input', (e) => renderAllAttendanceLog(e.target.value));
            UIElements.adminClassSelect?.addEventListener('change', handleAdminClassSelect);
            UIElements.saveScheduleButton?.addEventListener('click', handleUpdateSchedule);
            UIElements.addClassForm?.addEventListener('submit', handleAddClass);

            // Realtime Subs Functions
            function subscribeToClassChanges() {
                supabase.channel('public:classes').on('postgres_changes', { event: '*', schema: 'public', table: 'classes' }, async () => {
                    await fetchClasses(); renderClassList(); populateAdminClassesDropdown();
                }).subscribe();
            }
            function subscribeToAttendanceChanges() {
                supabase.channel('public:attendance_log').on('postgres_changes', { event: '*', schema: 'public', table: 'attendance_log' }, async () => {
                    if (appState.profile?.role === 'admin') {
                        await fetchAllTodayAttendance(); renderAllAttendanceLog(UIElements.searchStudentInput?.value || '');
                    }
                }).subscribe();
            }

            lucide.createIcons();
        });

        // CSV Export
        function populateProfileModal() { /* implemented above */ }
        document.getElementById('export-csv-button')?.addEventListener('click', () => {
            if (!appState.allAttendanceLogs.length) return showToast('Data kosong', 'info');
            const csv = ['Nama,NISN,Kelas,Jenis,Waktu,Status,Tanggal'].join(',') + '\n' + 
                appState.allAttendanceLogs.map(l => [
                    `"${l.profiles?.full_name||''}"`,`"${l.profiles?.nisn||''}"`,`"${l.profiles?.classes?.class_name||''}"`,
                    l.type, l.log_time, l.status, l.log_date
                ].join(',')).join('\n');
            
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
            a.download = `Absensi_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        });

        // Password Toggle
        document.querySelectorAll('.toggle-password').forEach(btn => {
            btn.addEventListener('click', function() {
                const inp = this.previousElementSibling;
                const icon = this.querySelector('i');
                if (inp.type === 'password') { inp.type = 'text'; icon.setAttribute('data-lucide', 'eye-off'); }
                else { inp.type = 'password'; icon.setAttribute('data-lucide', 'eye'); }
                lucide.createIcons();
            });
        });
    </script>
</head>
<body>

    <div id="loading-screen" class="fixed inset-0 flex flex-col justify-center items-center z-[9999] hidden">
        <div class="spinner"></div>
        <p class="mt-6 text-white text-lg font-semibold">Memuat...</p>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 z-[10000] overflow-hidden rounded-xl" style="opacity: 0; transform: translateY(10px);"></div>

    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md login-container">
            <!-- Login View -->
            <div id="login-view">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 mx-auto mb-4 glass-effect rounded-2xl shadow-lg flex items-center justify-center"><i data-lucide="school" class="w-10 h-10 text-white"></i></div>
                    <h2 class="text-4xl font-bold text-white mb-2">Selamat Datang</h2>
                    <p class="text-purple-100">Masuk ke Sistem Absensi Sekolah</p>
                </div>
                <div id="login-error" class="mb-4 p-4 glass-effect border-l-4 border-red-400 text-white rounded-lg hidden flex items-center gap-2"></div>
                <form id="login-form" class="space-y-5 glass-effect p-8 rounded-2xl">
                    <div><label class="block text-sm font-semibold text-white mb-2">Email atau NISN</label><input name="identifier" required class="w-full px-4 py-3 rounded-xl transition-all text-white placeholder-white/50"></div>
                    <div><label class="block text-sm font-semibold text-white mb-2">Password</label><div class="relative"><input type="password" name="password" required class="w-full px-4 py-3 rounded-xl transition-all text-white placeholder-white/50"><button type="button" class="toggle-password absolute right-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white"><i data-lucide="eye" class="w-5 h-5"></i></button></div></div>
                    <button type="submit" class="w-full btn-primary text-white py-3 rounded-xl font-bold text-lg shadow-lg">Masuk</button>
                </form>
                <div class="mt-6 text-center text-sm space-y-3"><button id="show-forgot-password-button" class="text-white hover:text-purple-200 font-medium">Lupa password?</button><p class="text-purple-100">Belum punya akun? <button id="show-signup-button" class="text-white hover:text-purple-200 font-bold underline">Daftar di sini</button></p></div>
            </div>
            <!-- Signup View -->
            <div id="signup-view" class="hidden">
                <div class="text-center mb-8"><div class="w-20 h-20 mx-auto mb-4 glass-effect rounded-2xl shadow-lg flex items-center justify-center"><i data-lucide="user-plus" class="w-10 h-10 text-white"></i></div><h2 class="text-4xl font-bold text-white mb-2">Buat Akun</h2></div>
                <div id="signup-error" class="mb-4 p-4 glass-effect border-l-4 border-red-400 text-white rounded-lg hidden flex items-center gap-2"></div>
                <form id="signup-form" class="space-y-5 glass-effect p-8 rounded-2xl">
                    <div><label class="block text-sm font-semibold text-white mb-2">Nama Lengkap</label><input name="full_name" required class="w-full px-4 py-3 rounded-xl text-white"></div>
                    <div><label class="block text-sm font-semibold text-white mb-2">Email</label><input type="email" name="email" required class="w-full px-4 py-3 rounded-xl text-white"></div>
                    <div><label class="block text-sm font-semibold text-white mb-2">NISN (10 digit)</label><input name="nisn" required maxlength="10" pattern="\d{10}" class="w-full px-4 py-3 rounded-xl text-white"></div>
                    <div><label class="block text-sm font-semibold text-white mb-2">Kelas</label><select id="signup-class-select" name="class_id" required class="w-full px-4 py-3 rounded-xl text-white appearance-none"><option value="" disabled selected>Memuat...</option></select></div>
                    <div><label class="block text-sm font-semibold text-white mb-2">Password</label><div class="relative"><input type="password" name="password" required class="w-full px-4 py-3 rounded-xl text-white"><button type="button" class="toggle-password absolute right-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white"><i data-lucide="eye" class="w-5 h-5"></i></button></div></div>
                    <button type="submit" class="w-full btn-primary text-white py-3 rounded-xl font-bold text-lg shadow-lg">Daftar Sekarang</button>
                </form>
                <div class="mt-6 text-center"><p class="text-purple-100">Sudah punya akun? <button id="show-login-button" class="text-white hover:text-purple-200 font-bold underline">Masuk di sini</button></p></div>
            </div>
            <!-- Forgot PW -->
            <div id="forgot-password-view" class="hidden">
                <div class="text-center mb-8"><div class="w-20 h-20 mx-auto mb-4 glass-effect rounded-2xl shadow-lg flex items-center justify-center"><i data-lucide="key" class="w-10 h-10 text-white"></i></div><h2 class="text-4xl font-bold text-white mb-2">Reset Password</h2></div>
                <form id="forgot-password-form" class="space-y-5 glass-effect p-8 rounded-2xl">
                    <div><label class="block text-sm font-semibold text-white mb-2">Email</label><input name="email" type="email" required class="w-full px-4 py-3 rounded-xl text-white"></div>
                    <button type="submit" class="w-full btn-primary text-white py-3 rounded-xl font-bold text-lg">Kirim Link Reset</button>
                </form>
                <div class="mt-6 text-center"><button id="back-to-login-button" class="text-white hover:text-purple-200 flex items-center gap-2 mx-auto"><i data-lucide="arrow-left" class="w-4 h-4"></i>Kembali ke login</button></div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden min-h-screen">
        <header class="glass-effect sticky top-0 z-40 border-b border-white/20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 glass-effect rounded-xl flex items-center justify-center shadow-lg"><i data-lucide="school" class="w-6 h-6 text-white"></i></div>
                    <div><h1 class="text-xl font-bold text-white">Sistem Absensi</h1><p class="text-sm text-purple-100">Kelola absensi dan jadwal</p></div>
                </div>
                <div class="relative">
                    <button id="profile-button" class="flex items-center gap-2 text-white font-semibold glass-effect px-3 py-1.5 rounded-full hover:bg-white/20 shadow-md">
                        <img id="header-pfp" src="" class="w-8 h-8 rounded-full border-2 border-white/50 object-cover bg-white/20">
                        <span id="welcome-message" class="hidden sm:inline font-semibold">User</span><i data-lucide="chevron-down" class="w-4 h-4 opacity-70"></i>
                    </button>
                    <div id="profile-dropdown" class="hidden absolute top-full mt-2 right-0 glass-effect rounded-xl shadow-2xl p-2 z-50 min-w-[180px] border border-white/20">
                        <button id="profile-modal-open-btn" class="flex w-full items-center gap-2 px-3 py-2 text-white hover:bg-white/10 rounded-lg text-sm"><i data-lucide="user-cog" class="w-4 h-4"></i>Edit Profil</button>
                        <button id="logout-button" class="flex w-full items-center gap-2 px-3 py-2 text-red-300 hover:bg-red-500/20 rounded-lg text-sm"><i data-lucide="log-out" class="w-4 h-4"></i>Keluar</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Student View -->
        <div id="student-view" class="max-w-7xl mx-auto p-4 sm:p-6 space-y-6 hidden">
            <div class="glass-effect rounded-2xl p-6 sm:p-8 text-center shadow-xl card-hover">
                <div class="mb-6"><h2 id="clock" class="clock-display gradient-text mb-2">00:00:00</h2><p id="date" class="text-white-glass text-lg">-</p></div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 justify-center">
                    <button id="check-in-button" class="px-6 py-4 btn-primary text-white rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2"><i data-lucide="log-in" class="w-5 h-5"></i>Masuk</button>
                    <button id="check-out-button" class="px-6 py-4 btn-primary text-white rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2"><i data-lucide="log-out" class="w-5 h-5"></i>Pulang</button>
                    <button id="izin-button" class="px-6 py-4 btn-info-custom text-white rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2"><i data-lucide="file-text" class="w-5 h-5"></i>Izin</button>
                    <button id="sakit-button" class="px-6 py-4 btn-warning-custom text-white rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2"><i data-lucide="thermometer" class="w-5 h-5"></i>Sakit</button>
                </div>
            </div>
            <div class="grid lg:grid-cols-2 gap-6">
                <div class="glass-effect rounded-2xl p-6 shadow-lg card-hover">
                    <div class="flex items-center gap-3 mb-4"><div class="w-10 h-10 glass-effect rounded-lg flex items-center justify-center"><i data-lucide="clipboard-list" class="w-5 h-5 text-white"></i></div><h3 class="text-xl font-bold text-white">Riwayat Hari Ini</h3></div>
                    <div id="attendance-log-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
                </div>
                <div class="glass-effect rounded-2xl p-6 shadow-lg card-hover">
                    <div class="flex items-center gap-3 mb-4"><div class="w-10 h-10 glass-effect rounded-lg flex items-center justify-center"><i data-lucide="calendar" class="w-5 h-5 text-white"></i></div><h3 class="text-xl font-bold text-white">Jadwal</h3></div>
                    <div class="overflow-x-auto relative -mx-2 max-h-96">
                        <table class="w-full text-xs min-w-[600px]"><thead><tr class="border-b-2 border-white/20"><th class="p-3 text-left font-bold text-white sticky left-0 z-20" style="background:rgba(249,250,251,0.15);backdrop-filter:blur(10px);">Waktu</th><th class="p-3 text-center font-bold text-white">Sen</th><th class="p-3 text-center font-bold text-white">Sel</th><th class="p-3 text-center font-bold text-white">Rab</th><th class="p-3 text-center font-bold text-white">Kam</th><th class="p-3 text-center font-bold text-white">Jum</th></tr></thead><tbody id="schedule-table-body"></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin View -->
        <div id="admin-view" class="max-w-7xl mx-auto p-4 sm:p-6 space-y-6 hidden">
            <div class="glass-effect rounded-2xl p-6 shadow-lg">
                <h3 class="text-xl font-bold text-white mb-6">Ringkasan Absensi</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="glass-effect p-4 rounded-xl text-center border-l-4 border-emerald-400"><p class="text-sm text-emerald-200 font-semibold">Tepat Masuk</p><span id="count-tepat" class="text-4xl font-bold text-white">0</span></div>
                    <div class="glass-effect p-4 rounded-xl text-center border-l-4 border-yellow-400"><p class="text-sm text-yellow-200 font-semibold">Telat Masuk</p><span id="count-telat" class="text-4xl font-bold text-white">0</span></div>
                    <div class="glass-effect p-4 rounded-xl text-center border-l-4 border-blue-400"><p class="text-sm text-blue-200 font-semibold">Izin</p><span id="count-izin" class="text-4xl font-bold text-white">0</span></div>
                    <div class="glass-effect p-4 rounded-xl text-center border-l-4 border-orange-400"><p class="text-sm text-orange-200 font-semibold">Sakit</p><span id="count-sakit" class="text-4xl font-bold text-white">0</span></div>
                </div>
            </div>

            <div class="glass-effect rounded-2xl p-6 shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between gap-4 mb-6">
                    <div class="flex items-center gap-3"><div class="w-10 h-10 glass-effect rounded-lg flex items-center justify-center"><i data-lucide="users" class="w-5 h-5 text-white"></i></div><h3 class="text-xl font-bold text-white">Data Absensi</h3></div>
                    <div class="flex gap-2"><button id="refresh-attendance-button" class="px-4 py-2 glass-effect text-white rounded-xl flex items-center gap-2"><i data-lucide="refresh-cw" class="w-4 h-4"></i>Refresh</button><button id="export-csv-button" class="px-4 py-2 btn-primary text-white rounded-xl flex items-center gap-2"><i data-lucide="download" class="w-4 h-4"></i>CSV</button></div>
                </div>
                <input id="search-student-input" placeholder="Cari Nama, NISN, Email, Kelas..." class="w-full mb-4 px-4 py-3 rounded-xl text-white">
                <div class="overflow-x-auto -mx-2 max-h-[500px]">
                    <table class="w-full text-sm min-w-[700px]"><thead><tr class="border-b-2 border-white/20"><th class="p-3 text-left font-bold text-white">Siswa</th><th class="p-3 text-left font-bold text-white">Email</th><th class="p-3 text-left font-bold text-white">Kelas</th><th class="p-3 text-left font-bold text-white">Jenis</th><th class="p-3 text-left font-bold text-white">Waktu</th><th class="p-3 text-left font-bold text-white">Status</th></tr></thead><tbody id="admin-attendance-log-body"></tbody></table>
                </div>
            </div>

            <div class="glass-effect rounded-2xl p-6 shadow-lg">
                <div class="flex items-center gap-3 mb-6"><div class="w-10 h-10 glass-effect rounded-lg flex items-center justify-center"><i data-lucide="calendar-days" class="w-5 h-5 text-white"></i></div><h3 class="text-xl font-bold text-white">Kelola Jadwal</h3></div>
                <select id="admin-class-select" class="w-full mb-4 px-4 py-3 rounded-xl text-white appearance-none"><option value="" disabled selected>Pilih kelas...</option></select>
                <div id="admin-schedule-container" class="hidden">
                    <div class="overflow-x-auto relative -mx-2 mb-4 max-h-[500px]">
                        <table class="w-full text-xs min-w-[700px]"><thead><tr class="border-b-2 border-white/20"><th class="p-3 text-left font-bold text-white sticky left-0 z-20" style="background:rgba(249,250,251,0.15);backdrop-filter:blur(10px);">Waktu</th><th class="p-3 text-center font-bold text-white">Senin</th><th class="p-3 text-center font-bold text-white">Selasa</th><th class="p-3 text-center font-bold text-white">Rabu</th><th class="p-3 text-center font-bold text-white">Kamis</th><th class="p-3 text-center font-bold text-white">Jumat</th></tr></thead><tbody id="admin-schedule-table-body"></tbody></table>
                    </div>
                    <button id="save-schedule-button" class="w-full px-6 py-4 btn-primary text-white rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2"><i data-lucide="save" class="w-5 h-5"></i>Simpan Jadwal</button>
                </div>
            </div>

            <div id="admin-class-management" class="glass-effect rounded-2xl p-6 shadow-lg">
                <div class="flex items-center gap-3 mb-6"><div class="w-10 h-10 glass-effect rounded-lg flex items-center justify-center"><i data-lucide="landmark" class="w-5 h-5 text-white"></i></div><h3 class="text-xl font-bold text-white">Kelola Kelas</h3></div>
                <form id="add-class-form" class="flex gap-2 mb-4"><input id="new-class-name" placeholder="Nama kelas baru" required class="flex-grow px-4 py-3 rounded-xl text-white"><button type="submit" class="px-6 py-3 btn-primary text-white rounded-xl font-semibold shadow-lg flex items-center gap-2"><i data-lucide="plus" class="w-5 h-5"></i>Tambah</button></form>
                <ul id="admin-class-list" class="max-h-60 overflow-y-auto glass-effect rounded-lg divide-y divide-white/10"><li class="text-white-glass italic px-4 py-2">Memuat...</li></ul>
            </div>
        </div>
    </div>

    <!-- Modal Edit Profil -->
    <div id="profile-modal" class="modal-overlay hidden">
        <div class="modal-content glass-effect rounded-2xl shadow-2xl p-6 sm:p-8 max-w-lg">
            <div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-bold text-white">Edit Profil</h3><button id="close-profile-modal" class="text-white/70 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <form id="profile-form" class="space-y-5">
                <div class="flex flex-col items-center gap-4">
                    <img id="profile-image-preview" src="" class="w-32 h-32 rounded-full object-cover border-4 border-white/30 shadow-lg bg-white/20">
                    <div class="flex gap-2"><input type="file" id="profile-image-input" class="hidden" accept="image/png, image/jpeg"><button id="profile-image-upload-btn" type="button" class="px-4 py-2 btn-secondary text-white rounded-xl text-sm flex items-center gap-2"><i data-lucide="upload" class="w-4 h-4"></i>Ganti</button><button id="remove-profile-image-btn" type="button" class="px-4 py-2 btn-danger text-white rounded-xl text-sm flex items-center gap-2"><i data-lucide="trash-2" class="w-4 h-4"></i>Hapus</button></div>
                </div>
                <div><label class="block text-sm font-semibold text-white mb-2">Nama Lengkap</label><input id="profile-full-name" required class="w-full px-4 py-3 rounded-xl text-white"></div>
                <div><label class="block text-sm font-semibold text-white mb-2">Email</label><input id="profile-email" readonly disabled class="w-full px-4 py-3 rounded-xl text-white opacity-70"></div>
                <div><label class="block text-sm font-semibold text-white mb-2">NISN</label><input id="profile-nisn" readonly disabled class="w-full px-4 py-3 rounded-xl text-white opacity-70"></div>
                <button id="profile-save-btn" type="submit" class="w-full btn-primary text-white py-3 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2"><i data-lucide="save" class="w-5 h-5"></i>Simpan</button>
            </form>
        </div>
    </div>

    <!-- Modal Cropper -->
    <div id="cropper-modal" class="modal-overlay hidden">
        <div id="cropper-modal-content" class="modal-content glass-effect rounded-2xl shadow-2xl p-6 sm:p-8">
            <h3 class="text-2xl font-bold text-white mb-4">Sesuaikan Gambar</h3>
            <div id="cropper-container" class="mb-4 bg-black rounded-lg overflow-hidden"><img id="cropper-image" src="" alt="Crop"></div>
            <div class="flex justify-center gap-3 mb-6"><button id="cropper-rotate-left-btn" type="button" class="px-4 py-2 btn-secondary text-white rounded-xl"><i data-lucide="rotate-ccw" class="w-5 h-5"></i></button><button id="cropper-rotate-right-btn" type="button" class="px-4 py-2 btn-secondary text-white rounded-xl"><i data-lucide="rotate-cw" class="w-5 h-5"></i></button></div>
            <div class="flex gap-4"><button id="cropper-cancel-btn" type="button" class="flex-1 btn-secondary text-white py-3 rounded-xl font-bold">Batal</button><button id="cropper-apply-btn" type="button" class="flex-1 btn-primary text-white py-3 rounded-xl font-bold flex justify-center gap-2"><i data-lucide="check" class="w-5 h-5"></i>Terapkan</button></div>
        </div>
    </div>
</body>
</html>
