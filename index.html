<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Sekolah Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
            pointer-events: none;
            z-index: -1;
        }

        .glass-effect {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-primary {
            background-color: #3b82f6; /* Tailwind blue-500 */
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Tailwind blue-600 */
        }
        
        .modal {
            background-color: rgba(0, 0, 0, 0.6);
        }

        /* Styling for inputs to blend with glass effect */
        input[type="text"], input[type="time"], select {
            background-color: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: background-color 0.2s, border-color 0.2s;
        }
        input[type="text"]:focus, input[type="time"]:focus, select:focus {
            background-color: rgba(255, 255, 255, 0.25);
            border-color: #ffffff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
        }
        
        /* Custom scrollbar for better aesthetics */
        .glass-effect::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .glass-effect::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .glass-effect::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        .glass-effect::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Header Section -->
    <header class="text-center mb-10">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-white mb-2 tracking-wide drop-shadow-lg">
            Sistem Absensi Sekolah Digital
        </h1>
        <p class="text-white/80 text-lg font-medium drop-shadow-md">Panel Administrasi</p>
    </header>

    <!-- Main Content Grid -->
    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6 max-w-7xl mx-auto">
        
        <!-- Column 1: Jadwal Pelajaran (Schedule Management) -->
        <div class="lg:col-span-1 space-y-6">

            <div id="admin-schedule-management" class="glass-effect rounded-2xl p-6 shadow-lg">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 glass-effect rounded-lg flex items-center justify-center">
                        <i data-lucide="calendar-check" class="w-5 h-5 text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white">Kelola Jadwal Pelajaran</h3>
                </div>

                <form id="add-schedule-form" class="space-y-4">
                    <div class="flex gap-2">
                        <input id="schedule-start-time" type="time" required class="flex-1 px-4 py-3 rounded-xl text-white placeholder-white/50" value="07:00">
                        <input id="schedule-end-time" type="time" required class="flex-1 px-4 py-3 rounded-xl text-white placeholder-white/50" value="07:45">
                    </div>
                    <input id="schedule-lesson-name" type="text" placeholder="Masukkan Nama Pelajaran (cth: Matematika)" required class="w-full px-4 py-3 rounded-xl text-white placeholder-white/50">
                    <button type="submit" class="w-full px-6 py-3 btn-primary text-white rounded-xl font-semibold shadow-lg flex items-center justify-center gap-2">
                        <i data-lucide="plus" class="w-5 h-5"></i> Tambah Jadwal
                    </button>
                </form>

                <h4 class="text-md font-semibold text-white mt-6 mb-2">Daftar Jadwal Hari Ini:</h4>
                <ul id="admin-schedule-list" class="max-h-60 overflow-y-auto glass-effect rounded-lg divide-y divide-white/10 p-2">
                    <!-- Schedule items will be dynamically inserted here -->
                </ul>

                <p class="text-sm text-white/70 mt-4 p-2 rounded-lg bg-black/10">
                    Jadwal akan digunakan untuk mencatat absensi siswa secara real-time.
                </p>
            </div>
        </div>

        <!-- Column 2: Pelajaran Aktif (Active Lesson & Attendance) -->
        <div class="lg:col-span-2 space-y-6">

            <div id="admin-active-lesson" class="glass-effect rounded-2xl p-6 shadow-lg">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 glass-effect rounded-lg flex items-center justify-center">
                        <i data-lucide="graduation-cap" class="w-5 h-5 text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white">Pelajaran Aktif Saat Ini</h3>
                </div>

                <div class="bg-black/10 rounded-xl p-4 mb-4">
                    <p class="text-sm text-white/70">Waktu:</p>
                    <p id="current-time-display" class="text-2xl font-extrabold text-white mb-3">--:--</p>
                    
                    <p class="text-sm text-white/70">Pelajaran:</p>
                    <p id="active-lesson-name" class="text-3xl font-bold text-yellow-300">Menunggu Jadwal...</p>
                    
                    <p class="text-sm text-white/70 mt-3">Sesi:</p>
                    <p id="active-lesson-time" class="text-xl font-semibold text-white">--:-- hingga --:--</p>
                    
                </div>
                
                <h4 class="text-md font-semibold text-white mb-2">Pilih Kelas untuk Absensi:</h4>
                <select id="attendance-class-select" class="w-full px-4 py-3 rounded-xl text-white placeholder-white/50 bg-black/20">
                    <option value="" disabled selected>Pilih Kelas</option>
                    <!-- Class options will be dynamically inserted here -->
                </select>

                <div id="attendance-panel" class="hidden mt-4">
                    <h4 class="text-md font-semibold text-white mb-2">Daftar Siswa Kelas <span id="selected-class-name"></span>:</h4>
                    <ul id="student-list" class="max-h-60 overflow-y-auto glass-effect rounded-lg divide-y divide-white/10 p-2">
                        <!-- Student items will be dynamically inserted here -->
                    </ul>
                    <p id="no-students-message" class="text-white/70 p-4 text-center hidden">Tidak ada siswa terdaftar di kelas ini.</p>
                </div>
            </div>

            <div id="admin-student-management" class="glass-effect rounded-2xl p-6 shadow-lg">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 glass-effect rounded-lg flex items-center justify-center">
                        <i data-lucide="users" class="w-5 h-5 text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white">Kelola Siswa</h3>
                </div>

                <form id="add-student-form" class="space-y-4">
                    <input id="student-name" type="text" placeholder="Nama Siswa" required class="w-full px-4 py-3 rounded-xl text-white placeholder-white/50">
                    <select id="student-class" required class="w-full px-4 py-3 rounded-xl text-white placeholder-white/50 bg-black/20">
                        <option value="" disabled selected>Pilih Kelas Siswa</option>
                        <!-- Class options will be dynamically inserted here -->
                    </select>
                    <button type="submit" class="w-full px-6 py-3 btn-primary text-white rounded-xl font-semibold shadow-lg flex items-center justify-center gap-2">
                        <i data-lucide="user-plus" class="w-5 h-5"></i> Tambah Siswa
                    </button>
                </form>

                <h4 class="text-md font-semibold text-white mt-6 mb-2">Daftar Semua Siswa:</h4>
                <ul id="all-student-list" class="max-h-60 overflow-y-auto glass-effect rounded-lg divide-y divide-white/10 p-2">
                    <!-- All student items will be dynamically inserted here -->
                </ul>
                <p id="no-students-all-message" class="text-white/70 p-4 text-center hidden">Belum ada siswa yang terdaftar.</p>
            </div>
        </div>

        <!-- Column 3: Kelola Kelas (Class Management) -->
        <div class="lg:col-span-1 space-y-6">
            <div id="help-card" class="glass-effect rounded-2xl p-6 shadow-lg">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 glass-effect rounded-lg flex items-center justify-center">
                        <i data-lucide="info" class="w-5 h-5 text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white">Cara Penggunaan</h3>
                </div>
                <ul class="text-white/80 space-y-3 list-disc list-inside text-sm">
                    <li>Gunakan menu **Kelola Kelas** untuk menambahkan kelas baru (misal: "X IPA 1").</li>
                    <li>Gunakan menu **Kelola Siswa** untuk mendaftarkan siswa ke kelas yang sudah dibuat.</li>
                    <li>Gunakan menu **Kelola Jadwal** untuk menentukan jam pelajaran. **Istirahat** otomatis terdeteksi.</li>
                    <li>Lihat **Pelajaran Aktif** untuk mencatat absensi siswa sesuai jadwal saat ini.</li>
                    <li>Untuk mencatat absensi, pilih kelas di panel **Pelajaran Aktif**, lalu klik simpan.</li>
                </ul>
            </div>

            <div id="admin-class-management" class="glass-effect rounded-2xl p-6 shadow-lg">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 glass-effect rounded-lg flex items-center justify-center">
                        <i data-lucide="landmark" class="w-5 h-5 text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white">Kelola Kelas</h3>
                </div>

                <form id="add-class-form" class="flex gap-2 mb-4">
                    <input id="new-class-name" type="text" placeholder="Masukkan nama kelas baru" required class="flex-grow px-4 py-3 rounded-xl text-white placeholder-white/50">
                    <button type="submit" class="px-6 py-3 btn-primary text-white rounded-xl font-semibold shadow-lg flex items-center gap-2">
                        <i data-lucide="plus" class="w-5 h-5"></i> Tambah
                    </button>
                </form>

                <h4 class="text-md font-semibold text-white mb-2">Daftar Kelas Tersedia:</h4>
                <ul id="admin-class-list" class="max-h-60 overflow-y-auto glass-effect rounded-lg divide-y divide-white/10">
                    <!-- Class items will be dynamically inserted here -->
                </ul>
                <p id="no-classes-message" class="text-white/70 p-4 text-center hidden">Belum ada kelas yang terdaftar.</p>
            </div>
        </div>

    </main>

    <!-- Modal for Custom Confirmation/Message -->
    <div id="custom-modal" class="modal fixed inset-0 flex items-center justify-center z-50 hidden p-4">
        <div class="glass-effect bg-white/10 rounded-2xl p-6 w-full max-w-md shadow-2xl transform transition-all scale-100 opacity-100">
            <h4 id="modal-title" class="text-xl font-bold text-white mb-4">Pesan</h4>
            <p id="modal-message" class="text-white/90 mb-6">Ini adalah pesan modal.</p>
            <div class="flex justify-end gap-3">
                <button id="modal-confirm-btn" class="hidden px-4 py-2 bg-red-600 text-white rounded-xl font-semibold shadow-lg hover:bg-red-700 transition">Hapus</button>
                <button id="modal-close-btn" class="px-4 py-2 bg-gray-500 text-white rounded-xl font-semibold shadow-lg hover:bg-gray-600 transition">Tutup</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, collection, onSnapshot, query, deleteDoc, 
            serverTimestamp, arrayUnion, arrayRemove, updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level
        setLogLevel('Debug');

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-absensi-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Data Models
        let classes = [];
        let students = [];
        let lessonSchedules = [
            // Jadwal pelajaran awal
            { start: '07:00', end: '07:45', name: 'Pelajaran 1' },
            { start: '07:45', end: '08:30', name: 'Pelajaran 2' },
            { start: '08:30', end: '09:15', name: 'Pelajaran 3' },
            // Istirahat 1
            { start: '09:15', end: '09:30', name: 'Pelajaran 4' },
            { start: '09:30', end: '09:45', name: 'Istirahat', isBreak: true }, // BREAK ADDED HERE
            { start: '09:45', end: '10:30', name: 'Pelajaran 5' },
            { start: '10:30', end: '11:15', name: 'Pelajaran 6' },
            { start: '11:15', end: '12:00', name: 'Pelajaran 7' },
            // Istirahat 2 (Makan Siang)
            { start: '12:00', end: '12:45', name: 'Istirahat Siang', isBreak: true }, // BREAK ADDED HERE
            { start: '12:45', end: '13:30', name: 'Pelajaran 8' },
            { start: '13:30', end: '14:15', name: 'Pelajaran 9' },
            { start: '14:15', end: '15:00', name: 'Pelajaran 10' }
        ];

        // UI Elements
        const addClassForm = document.getElementById('add-class-form');
        const newClassNameInput = document.getElementById('new-class-name');
        const adminClassList = document.getElementById('admin-class-list');
        const noClassesMessage = document.getElementById('no-classes-message');
        const studentClassSelect = document.getElementById('student-class');
        const studentNameInput = document.getElementById('student-name');
        const addStudentForm = document.getElementById('add-student-form');
        const allStudentList = document.getElementById('all-student-list');
        const noStudentsAllMessage = document.getElementById('no-students-all-message');
        const attendanceClassSelect = document.getElementById('attendance-class-select');
        const attendancePanel = document.getElementById('attendance-panel');
        const selectedClassName = document.getElementById('selected-class-name');
        const studentListForAttendance = document.getElementById('student-list');
        const noStudentsMessage = document.getElementById('no-students-message');
        const addScheduleForm = document.getElementById('add-schedule-form');
        const scheduleStartTimeInput = document.getElementById('schedule-start-time');
        const scheduleEndTimeInput = document.getElementById('schedule-end-time');
        const scheduleLessonNameInput = document.getElementById('schedule-lesson-name');
        const adminScheduleList = document.getElementById('admin-schedule-list');
        const currentTimeDisplay = document.getElementById('current-time-display');
        const activeLessonName = document.getElementById('active-lesson-name');
        const activeLessonTime = document.getElementById('active-lesson-time');

        // Modal Elements
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');

        /**
         * Custom Modal Display Function
         * @param {string} title 
         * @param {string} message 
         * @param {boolean} isConfirm 
         * @param {function | null} onConfirm 
         */
        function showModal(title, message, isConfirm = false, onConfirm = null) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            customModal.classList.remove('hidden');

            if (isConfirm) {
                modalConfirmBtn.classList.remove('hidden');
                modalConfirmBtn.onclick = () => {
                    customModal.classList.add('hidden');
                    if (onConfirm) onConfirm();
                };
                // Close button acts as cancel
                modalCloseBtn.textContent = 'Batal';
                modalCloseBtn.onclick = () => {
                    customModal.classList.add('hidden');
                };
            } else {
                modalConfirmBtn.classList.add('hidden');
                modalCloseBtn.textContent = 'Tutup';
                modalCloseBtn.onclick = () => {
                    customModal.classList.add('hidden');
                };
            }
        }

        // --- Firebase Initialization and Authentication ---
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                showModal("Error Konfigurasi", "Konfigurasi Firebase tidak ditemukan.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in using custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated:", userId);
                    } else {
                        // This should not happen if signInWithCustomToken or signInAnonymously is successful
                        console.log("User signed out or failed to authenticate.");
                        userId = null;
                    }
                    isAuthReady = true;
                    // Once auth is ready, set up listeners
                    if (userId) {
                        setupFirestoreListeners();
                    } else {
                        showModal("Akses Gagal", "Gagal mendapatkan User ID. Fungsi penyimpanan data dinonaktifkan.");
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showModal("Error Inisialisasi", `Gagal menginisialisasi Firebase: ${error.message}`);
            }
        }

        // Helper to get collection path for private data
        function getPrivateCollectionPath(collectionName) {
            if (!userId) {
                console.error("User ID is not available.");
                return null;
            }
            // Path: /artifacts/{appId}/users/{userId}/{collectionName}
            return `artifacts/${appId}/users/${userId}/${collectionName}`;
        }

        // --- Firestore Listeners ---
        function setupFirestoreListeners() {
            if (!db || !userId) return;

            const classesPath = getPrivateCollectionPath('classes');
            if (classesPath) {
                const qClasses = query(collection(db, classesPath));
                onSnapshot(qClasses, (snapshot) => {
                    classes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderClasses();
                    renderStudentClassOptions();
                    renderAttendanceClassOptions();
                }, (error) => {
                    console.error("Error fetching classes:", error);
                    showModal("Error Data", `Gagal mengambil data kelas: ${error.message}`);
                });
            }

            const studentsPath = getPrivateCollectionPath('students');
            if (studentsPath) {
                const qStudents = query(collection(db, studentsPath));
                onSnapshot(qStudents, (snapshot) => {
                    students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderAllStudents();
                    // Re-render attendance panel if a class is selected
                    const selectedClassId = attendanceClassSelect.value;
                    if (selectedClassId) {
                        renderStudentsForAttendance(selectedClassId);
                    }
                }, (error) => {
                    console.error("Error fetching students:", error);
                    showModal("Error Data", `Gagal mengambil data siswa: ${error.message}`);
                });
            }
            
            // Listen for lesson schedules and render them
            const schedulesPath = getPrivateCollectionPath('schedules');
            if (schedulesPath) {
                 const qSchedules = query(collection(db, schedulesPath));
                 onSnapshot(qSchedules, (snapshot) => {
                    // Hanya memperbarui schedule jika ada data yang tersimpan di Firestore
                    if (!snapshot.empty) {
                        lessonSchedules = snapshot.docs[0].data().lessons || [];
                    }
                    renderSchedules();
                 }, (error) => {
                    console.error("Error fetching schedules:", error);
                    showModal("Error Data", `Gagal mengambil data jadwal: ${error.message}`);
                 });
            }
            
            // Save initial schedules to Firestore if the schedules collection doesn't exist yet
            checkAndSaveInitialSchedules(schedulesPath);
        }
        
        // Cek dan simpan jadwal awal ke Firestore jika belum ada
        async function checkAndSaveInitialSchedules(schedulesPath) {
            if (!db || !schedulesPath) return;

            try {
                // Menggunakan ID tetap 'default_schedule' untuk dokumen tunggal
                const scheduleDocRef = doc(db, schedulesPath, 'default_schedule');
                
                // Set/Update dokumen dengan jadwal, ini akan menimpanya jika sudah ada
                // atau membuatnya jika belum ada.
                await setDoc(scheduleDocRef, { lessons: lessonSchedules, updatedAt: serverTimestamp() });
                console.log("Initial or current schedules saved to Firestore.");
            } catch (error) {
                console.error("Error saving initial schedules:", error);
            }
        }

        // --- Class Management ---
        addClassForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) return showModal("Error", "Sistem belum siap. Mohon tunggu.");

            const className = newClassNameInput.value.trim();
            if (!className) return;

            const classesPath = getPrivateCollectionPath('classes');
            if (!classesPath) return;
            
            try {
                await setDoc(doc(collection(db, classesPath)), {
                    name: className,
                    createdAt: serverTimestamp()
                });
                newClassNameInput.value = '';
                showModal("Berhasil", `Kelas "${className}" berhasil ditambahkan.`);
            } catch (error) {
                console.error("Error adding class:", error);
                showModal("Error", `Gagal menambahkan kelas: ${error.message}`);
            }
        });

        function renderClasses() {
            adminClassList.innerHTML = '';
            if (classes.length === 0) {
                noClassesMessage.classList.remove('hidden');
                return;
            }
            noClassesMessage.classList.add('hidden');

            classes.forEach(cls => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 text-white transition hover:bg-white/10';
                li.innerHTML = `
                    <span class="font-medium">${cls.name}</span>
                    <button data-id="${cls.id}" data-name="${cls.name}" class="delete-class-btn text-red-400 hover:text-red-500 transition p-1 rounded-full">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                `;
                adminClassList.appendChild(li);
            });
            // Re-initialize lucide icons for newly added elements
            lucide.createIcons();

            // Attach delete listeners
            document.querySelectorAll('.delete-class-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    const name = e.currentTarget.getAttribute('data-name');
                    showModal("Konfirmasi Hapus", `Apakah Anda yakin ingin menghapus kelas "${name}"? Semua siswa di kelas ini akan kehilangan penugasan kelasnya.`, true, () => deleteClass(id));
                });
            });
        }

        async function deleteClass(classId) {
            if (!isAuthReady || !userId) return;

            const classesPath = getPrivateCollectionPath('classes');
            if (!classesPath) return;

            try {
                // 1. Delete the class document
                await deleteDoc(doc(db, classesPath, classId));
                
                // 2. Clear class assignment from all students in that class (Optional: More complex logic might be needed here)
                // For simplicity, we just delete the class. Students will remain but will have an invalid classId.
                
                showModal("Berhasil", "Kelas berhasil dihapus.");
            } catch (error) {
                console.error("Error deleting class:", error);
                showModal("Error", `Gagal menghapus kelas: ${error.message}`);
            }
        }

        // --- Student Management ---
        function renderStudentClassOptions() {
            // Clear existing options, keeping the default disabled one
            studentClassSelect.innerHTML = '<option value="" disabled selected>Pilih Kelas Siswa</option>';

            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                option.className = 'bg-gray-800 text-white'; // Style option for dark background
                studentClassSelect.appendChild(option);
            });
        }

        addStudentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) return showModal("Error", "Sistem belum siap. Mohon tunggu.");

            const studentName = studentNameInput.value.trim();
            const classId = studentClassSelect.value;

            if (!studentName || !classId) return showModal("Peringatan", "Nama siswa dan kelas harus diisi.");

            const studentsPath = getPrivateCollectionPath('students');
            if (!studentsPath) return;

            try {
                await setDoc(doc(collection(db, studentsPath)), {
                    name: studentName,
                    classId: classId,
                    createdAt: serverTimestamp()
                });
                studentNameInput.value = '';
                studentClassSelect.value = ''; // Reset select
                showModal("Berhasil", `Siswa "${studentName}" berhasil ditambahkan.`);
            } catch (error) {
                console.error("Error adding student:", error);
                showModal("Error", `Gagal menambahkan siswa: ${error.message}`);
            }
        });

        function renderAllStudents() {
            allStudentList.innerHTML = '';
            if (students.length === 0) {
                noStudentsAllMessage.classList.remove('hidden');
                return;
            }
            noStudentsAllMessage.classList.add('hidden');

            // Sort students by class name then by name
            const sortedStudents = students.map(s => {
                const cls = classes.find(c => c.id === s.classId);
                return { ...s, className: cls ? cls.name : 'Kelas Tidak Ditemukan' };
            }).sort((a, b) => {
                if (a.className < b.className) return -1;
                if (a.className > b.className) return 1;
                if (a.name < b.name) return -1;
                if (a.name > b.name) return 1;
                return 0;
            });

            sortedStudents.forEach(student => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 text-white transition hover:bg-white/10 text-sm';
                li.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-medium">${student.name}</span>
                        <span class="text-xs text-white/70">${student.className}</span>
                    </div>
                    <button data-id="${student.id}" data-name="${student.name}" class="delete-student-btn text-red-400 hover:text-red-500 transition p-1 rounded-full">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                `;
                allStudentList.appendChild(li);
            });
            lucide.createIcons();

            document.querySelectorAll('.delete-student-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    const name = e.currentTarget.getAttribute('data-name');
                    showModal("Konfirmasi Hapus", `Apakah Anda yakin ingin menghapus siswa "${name}"?`, true, () => deleteStudent(id));
                });
            });
        }

        async function deleteStudent(studentId) {
            if (!isAuthReady || !userId) return;

            const studentsPath = getPrivateCollectionPath('students');
            if (!studentsPath) return;

            try {
                await deleteDoc(doc(db, studentsPath, studentId));
                showModal("Berhasil", "Siswa berhasil dihapus.");
            } catch (error) {
                console.error("Error deleting student:", error);
                showModal("Error", `Gagal menghapus siswa: ${error.message}`);
            }
        }

        // --- Schedule Management ---
        
        function renderSchedules() {
            adminScheduleList.innerHTML = '';

            // Sort by start time for display
            const sortedSchedules = [...lessonSchedules].sort((a, b) => {
                if (a.start < b.start) return -1;
                if (a.start > b.start) return 1;
                return 0;
            });

            sortedSchedules.forEach((schedule, index) => {
                const isBreak = schedule.isBreak;
                const li = document.createElement('li');
                li.className = `flex justify-between items-center p-3 transition ${isBreak ? 'bg-yellow-800/20 text-yellow-300' : 'text-white hover:bg-white/10'}`;
                
                const nameText = isBreak ? `${schedule.name}` : `Pelajaran: ${schedule.name}`;

                li.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-semibold">${nameText}</span>
                        <span class="text-sm ${isBreak ? 'text-yellow-400/80' : 'text-white/70'}">${schedule.start} - ${schedule.end}</span>
                    </div>
                    ${!isBreak ? `
                        <button data-index="${index}" class="delete-schedule-btn text-red-400 hover:text-red-500 transition p-1 rounded-full">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    ` : ''}
                `;
                adminScheduleList.appendChild(li);
            });
            lucide.createIcons();
            
            // Re-attach listeners for dynamically created buttons
            document.querySelectorAll('.delete-schedule-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    showModal("Konfirmasi Hapus", `Apakah Anda yakin ingin menghapus jadwal ${sortedSchedules[index].name} (${sortedSchedules[index].start}-${sortedSchedules[index].end})?`, true, () => deleteSchedule(sortedSchedules[index]));
                });
            });
        }
        
        // Helper untuk menghapus jadwal berdasarkan objek (untuk menghandle urutan yang berubah)
        async function deleteSchedule(scheduleToDelete) {
             if (!isAuthReady || !userId) return;
             
             // Hapus dari array lokal
             lessonSchedules = lessonSchedules.filter(
                s => !(s.start === scheduleToDelete.start && s.end === scheduleToDelete.end && s.name === scheduleToDelete.name)
             );
             
             // Simpan perubahan ke Firestore
             await saveSchedulesToFirestore();
             showModal("Berhasil", `Jadwal "${scheduleToDelete.name}" berhasil dihapus.`);
        }

        addScheduleForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAuthReady || !userId) return;

            const startTime = scheduleStartTimeInput.value.trim();
            const endTime = scheduleEndTimeInput.value.trim();
            const lessonName = scheduleLessonNameInput.value.trim();

            if (!startTime || !endTime || !lessonName) return showModal("Peringatan", "Semua kolom jadwal harus diisi.");

            // Basic validation: ensure end time is after start time (optional, more complex validation needed for real-world)
            if (endTime <= startTime) {
                return showModal("Peringatan", "Waktu selesai harus setelah waktu mulai.");
            }

            const newSchedule = { start: startTime, end: endTime, name: lessonName };
            
            // Add to array
            lessonSchedules.push(newSchedule);
            
            // Simpan ke Firestore
            await saveSchedulesToFirestore();
            
            // Reset form
            scheduleLessonNameInput.value = '';
            // Update time inputs to suggest next slot (simple logic)
            // scheduleStartTimeInput.value = endTime; // Too complex for simple demo

            showModal("Berhasil", `Jadwal pelajaran "${lessonName}" berhasil ditambahkan.`);
        });
        
        async function saveSchedulesToFirestore() {
            if (!db || !userId) return;
            const schedulesPath = getPrivateCollectionPath('schedules');
            if (!schedulesPath) return;

            try {
                // Sorting the schedules by start time before saving
                const sortedLessons = [...lessonSchedules].sort((a, b) => {
                    if (a.start < b.start) return -1;
                    if (a.start > b.start) return 1;
                    return 0;
                });
                
                const scheduleDocRef = doc(db, schedulesPath, 'default_schedule');
                await setDoc(scheduleDocRef, { lessons: sortedLessons, updatedAt: serverTimestamp() }, { merge: true });
            } catch (error) {
                console.error("Error saving schedules:", error);
                showModal("Error", `Gagal menyimpan jadwal: ${error.message}`);
            }
        }

        // --- Active Lesson & Attendance ---
        function checkActiveLesson() {
            const now = new Date();
            // Format current time to HH:MM for easy comparison
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            currentTimeDisplay.textContent = currentTime;

            let activeLesson = null;
            
            // Sort by start time
            const sortedSchedules = [...lessonSchedules].sort((a, b) => {
                if (a.start < b.start) return -1;
                if (a.start > b.start) return 1;
                return 0;
            });
            
            for (const schedule of sortedSchedules) {
                if (currentTime >= schedule.start && currentTime < schedule.end) {
                    activeLesson = schedule;
                    break;
                }
            }

            if (activeLesson) {
                activeLessonName.textContent = activeLesson.name;
                activeLessonTime.textContent = `${activeLesson.start} hingga ${activeLesson.end}`;
                
                if (activeLesson.isBreak) {
                    activeLessonName.classList.remove('text-yellow-300');
                    activeLessonName.classList.add('text-sky-300');
                    activeLessonName.textContent = `${activeLesson.name} - Waktunya Santai!`;
                } else {
                    activeLessonName.classList.add('text-yellow-300');
                    activeLessonName.classList.remove('text-sky-300');
                }

            } else {
                activeLessonName.textContent = 'Menunggu Jadwal...';
                activeLessonTime.textContent = '--:-- hingga --:--';
                activeLessonName.classList.remove('text-sky-300');
                activeLessonName.classList.add('text-yellow-300');
            }
        }
        
        // Update active lesson every minute
        setInterval(checkActiveLesson, 60000); // 60 seconds
        checkActiveLesson(); // Initial check

        function renderAttendanceClassOptions() {
            // Clear existing options, keeping the default disabled one
            attendanceClassSelect.innerHTML = '<option value="" disabled selected>Pilih Kelas</option>';

            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls.id;
                option.textContent = cls.name;
                option.className = 'bg-gray-800 text-white'; // Style option for dark background
                attendanceClassSelect.appendChild(option);
            });
        }
        
        attendanceClassSelect.addEventListener('change', (e) => {
            const classId = e.target.value;
            const selectedClass = classes.find(c => c.id === classId);
            
            if (selectedClass) {
                selectedClassName.textContent = selectedClass.name;
                renderStudentsForAttendance(classId);
                attendancePanel.classList.remove('hidden');
            } else {
                attendancePanel.classList.add('hidden');
            }
        });

        function renderStudentsForAttendance(classId) {
            studentListForAttendance.innerHTML = '';
            const studentsInClass = students.filter(s => s.classId === classId)
                                            .sort((a, b) => a.name.localeCompare(b.name));

            if (studentsInClass.length === 0) {
                noStudentsMessage.classList.remove('hidden');
                return;
            }
            noStudentsMessage.classList.add('hidden');

            studentsInClass.forEach(student => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 text-white transition hover:bg-white/10';
                li.innerHTML = `
                    <span class="font-medium">${student.name}</span>
                    <div class="flex gap-2">
                        <button data-id="${student.id}" data-status="Hadir" class="record-attendance-btn px-3 py-1 bg-green-500 hover:bg-green-600 rounded-lg text-sm font-semibold">Hadir</button>
                        <button data-id="${student.id}" data-status="Izin" class="record-attendance-btn px-3 py-1 bg-yellow-500 hover:bg-yellow-600 rounded-lg text-sm font-semibold">Izin</button>
                        <button data-id="${student.id}" data-status="Alfa" class="record-attendance-btn px-3 py-1 bg-red-500 hover:bg-red-600 rounded-lg text-sm font-semibold">Alfa</button>
                    </div>
                `;
                studentListForAttendance.appendChild(li);
            });
            
            // Attach attendance listeners
            document.querySelectorAll('.record-attendance-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const studentId = e.target.getAttribute('data-id');
                    const status = e.target.getAttribute('data-status');
                    recordAttendance(studentId, status);
                });
            });
        }
        
        async function recordAttendance(studentId, status) {
            if (!isAuthReady || !userId) return;

            const activeLesson = getActiveLesson();
            if (!activeLesson || activeLesson.isBreak) {
                return showModal("Peringatan", "Tidak ada pelajaran aktif yang dapat dicatat absensinya saat ini.");
            }
            
            const studentsPath = getPrivateCollectionPath('students');
            if (!studentsPath) return;

            // Simple attendance structure: Store a map of date-lesson to status on the student document
            const dateKey = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
            const lessonKey = `${dateKey}_${activeLesson.start}-${activeLesson.end}`;
            
            try {
                const studentDocRef = doc(db, studentsPath, studentId);
                
                // Update the attendance record
                await updateDoc(studentDocRef, {
                    [`attendance.${lessonKey}`]: {
                        lesson: activeLesson.name,
                        time: serverTimestamp(),
                        status: status
                    }
                });

                showModal("Absensi Tercatat", `Absensi untuk siswa berhasil dicatat: Status **${status}** pada pelajaran **${activeLesson.name}**.`);
            } catch (error) {
                console.error("Error recording attendance:", error);
                showModal("Error", `Gagal mencatat absensi: ${error.message}`);
            }
        }
        
        function getActiveLesson() {
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            const sortedSchedules = [...lessonSchedules].sort((a, b) => {
                if (a.start < b.start) return -1;
                if (a.start > b.start) return 1;
                return 0;
            });

            for (const schedule of sortedSchedules) {
                if (currentTime >= schedule.start && currentTime < schedule.end) {
                    return schedule;
                }
            }
            return null;
        }


        // --- Initialize App ---
        window.onload = () => {
            // Create Lucide icons initially
            lucide.createIcons();
            // Start Firebase initialization and listening
            initializeFirebase();
            // Initial render of schedules (will be overwritten by Firestore listener)
            renderSchedules(); 
        };

    </script>
</body>
</html>
