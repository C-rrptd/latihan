<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistem Absensi Sekolah</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
    <!-- Supabase JS (only dependency) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        /* Custom config for Tailwind */
        :root {
            --color-primary-light: 109 40 217; /* Indigo 600 */
            --color-primary-base: 79 70 229;  /* Indigo 700 */
            --color-primary-dark: 67 56 202; /* Indigo 800 */
        }
        
        /* Apply font and background - Centering is handled here */
        body {
            font-family: 'Inter', system-ui, Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center; /* Vertical Center */
            justify-content: center; /* Horizontal Center */
            /* Modern, soft gradient background */
            background: linear-gradient(135deg, #a78bfa 0%, #6366f1 100%); 
        }

        /* Utility classes for primary color */
        .text-primary { color: rgb(var(--color-primary-base)); }
        .bg-primary { background-color: rgb(var(--color-primary-base)); }
        .hover\:bg-primary-dark:hover { background-color: rgb(var(--color-primary-dark)); }
        .focus\:ring-primary:focus { --tw-ring-color: rgb(var(--color-primary-base)); }
        .border-primary { border-color: rgb(var(--color-primary-base)); }

        /* Custom scrollbar for log list */
        #attendance-list {
            max-height: 250px;
            overflow-y: auto;
        }

        /* Responsive Wrapper */
        .wrap {
            width: 100%;
            padding: 1.5rem;
            /* Flexbox on body already handles centering, this container ensures padding */
        }
    </style>
</head>
<body>
    <div class="wrap">
        <!-- Main Card with soft shadow and large border radius -->
        <div class="w-full max-w-lg bg-white p-6 md:p-8 rounded-2xl shadow-2xl transition-shadow duration-300" id="app">
            
            <!-- Not Signed In View -->
            <div id="not-signed-in">
                <div class="text-center mb-6">
                    <i data-lucide="shield-check" class="w-10 h-10 text-primary mx-auto mb-2"></i>
                    <h1 class="text-3xl font-extrabold text-gray-800 mb-1">Sistem Absensi Digital</h1>
                    <p class="text-sm text-gray-500">Akses cepat menggunakan Email atau NISN + Password.</p>
                </div>

                <form id="login-form" autocomplete="on">
                    <div class="mb-4">
                        <label for="identifier" class="block text-sm font-semibold text-gray-700 mb-2">Email atau NISN</label>
                        <input id="identifier" name="identifier" type="text" inputmode="email" 
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-xl focus:border-primary focus:ring-1 focus:ring-primary transition duration-150" 
                               placeholder="Contoh: 10 digit NISN atau email@sekolah.id" required />
                    </div>

                    <div class="mb-6">
                        <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                        <div class="relative">
                            <input id="password" name="password" type="password" 
                                   class="w-full px-4 py-2.5 border border-gray-300 rounded-xl focus:border-primary focus:ring-1 focus:ring-primary transition duration-150 pr-12" 
                                   placeholder="Masukkan password Anda" required />
                            <button type="button" id="pwd-toggle" class="absolute right-0 top-0 mt-2.5 mr-3 text-gray-400 hover:text-gray-600 toggle-password" aria-pressed="false" title="Tampilkan password">
                                <i data-lucide="eye" id="eye-icon" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-3 items-center">
                        <button id="login-btn" class="flex-1 w-full sm:w-auto bg-primary text-white font-bold py-3 rounded-xl shadow-lg shadow-indigo-300/50 hover:bg-primary-dark transition duration-150 disabled:opacity-50" type="submit">
                            <i data-lucide="log-in" class="w-5 h-5 inline-block mr-2"></i> Masuk
                        </button>
                        <button id="signup-btn" class="flex-1 w-full sm:w-auto text-primary border border-primary font-semibold py-3 rounded-xl bg-white hover:bg-indigo-50 transition duration-150" type="button">
                            <i data-lucide="user-plus" class="w-5 h-5 inline-block mr-2"></i> Daftar
                        </button>
                    </div>
                </form>

                <div class="text-xs text-center text-gray-400 mt-6">
                    <a href="#" id="forgot-password-link" class="hover:text-primary">Lupa Password?</a>
                </div>
            </div>

            <!-- Signed In View (Home) -->
            <div id="signed-in" class="hidden">
                <!-- Profile Header -->
                <header class="flex justify-between items-center pb-4 border-b-2 border-indigo-100 mb-4">
                    <div class="flex items-center gap-4">
                        <div id="avatar" class="w-14 h-14 rounded-full bg-indigo-200 flex items-center justify-center text-white text-xl font-bold border-4 border-white shadow-md">
                            <i data-lucide="user" class="w-6 h-6 text-indigo-500"></i>
                        </div>
                        <div>
                            <div id="profile-name" class="font-extrabold text-gray-800 text-xl leading-tight">Selamat Datang!</div>
                            <div class="text-sm text-gray-500" id="profile-email"></div>
                        </div>
                    </div>
                    <button id="logout-btn" class="text-sm text-red-600 font-semibold px-3 py-1.5 rounded-lg border border-red-300 bg-red-50 hover:bg-red-100 transition duration-150">
                        <i data-lucide="log-out" class="w-4 h-4 inline-block mr-1"></i> Keluar
                    </button>
                </header>
                
                <!-- Attendance Status & Action -->
                <div class="bg-primary p-4 rounded-xl shadow-xl shadow-indigo-500/30 text-white mb-6" aria-live="polite">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="text-3xl font-extrabold" id="clock">00:00:00</div>
                            <div class="text-sm opacity-90" id="date">-</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 mt-4">
                        <button id="checkin" class="flex items-center justify-center bg-green-500 text-white font-bold py-3 rounded-lg hover:bg-green-600 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed shadow-md">
                            <i data-lucide="arrow-down-left" class="w-5 h-5 mr-2"></i> Masuk
                        </button>
                        <button id="checkout" class="flex items-center justify-center bg-red-500 text-white font-bold py-3 rounded-lg hover:bg-red-600 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed shadow-md">
                            <i data-lucide="arrow-up-right" class="w-5 h-5 mr-2"></i> Pulang
                        </button>
                    </div>
                </div>

                <!-- Attendance Log -->
                <h3 class="text-lg font-bold text-gray-700 mb-3 border-b border-gray-100 pb-1">Riwayat Absensi Hari Ini</h3>
                <div id="attendance-list" class="space-y-3">
                    <!-- Log entries will be inserted here -->
                </div>
            </div>

            <!-- Global Messages/Alerts -->
            <div id="messages" class="hidden fixed bottom-4 right-4 z-50 p-4 rounded-lg shadow-xl text-white font-medium transition-all duration-300 min-w-[200px]" role="alert"></div>
            
            <footer class="text-center text-xs text-gray-400 mt-8">
                Sistem Absensi Digital â€” Powered by Supabase
            </footer>
        </div>
    </div>

    <script>
        // ---------- CONFIG: replace with your Supabase project values ----------
        const SUPABASE_URL = 'https://qvunfkabbhulwqfnkren.supabase.co'; // REPLACE ME
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2dW5ma2FiYmh1bHdxZm5rcmVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNzkyOTksImV4cCI6MjA3NDg1NTI5OX0.2x_cwD11T4birj0NnAqzCqS_AtfZLqr65yb7ioV04IY'; // REPLACE ME
        // ----------------------------------------------------------------------

        // Initialize Supabase client
        if (!(window.supabase && typeof window.supabase.createClient === 'function')) {
            throw new Error('Supabase script failed to load. Check network or script URL.');
        }
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DOM references
        const notSigned = document.getElementById('not-signed-in');
        const signed = document.getElementById('signed-in');
        const messages = document.getElementById('messages');
        const loginForm = document.getElementById('login-form');
        const identifierInput = document.getElementById('identifier');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const pwdToggleBtn = document.getElementById('pwd-toggle');
        const eyeIcon = document.getElementById('eye-icon');
        const avatarEl = document.getElementById('avatar');
        const profileNameEl = document.getElementById('profile-name');
        const profileEmailEl = document.getElementById('profile-email');
        const logoutBtn = document.getElementById('logout-btn');
        const checkinBtn = document.getElementById('checkin');
        const checkoutBtn = document.getElementById('checkout');
        const attendanceList = document.getElementById('attendance-list');
        const clockEl = document.getElementById('clock');
        const dateEl = document.getElementById('date');
        const forgotPasswordLink = document.getElementById('forgot-password-link'); // Added reference

        let messageTimeout;

        // Helpers
        function showMessage(msg, type = 'info') {
            clearTimeout(messageTimeout);
            
            messages.textContent = msg;
            messages.classList.remove('hidden', 'bg-red-600', 'bg-green-600', 'bg-indigo-600');
            messages.classList.add('opacity-100');

            if (type === 'error') {
                messages.classList.add('bg-red-600');
            } else if (type === 'success') {
                messages.classList.add('bg-green-600');
            } else {
                messages.classList.add('bg-indigo-600');
            }

            // Hide after 5 seconds
            messageTimeout = setTimeout(() => { messages.classList.add('hidden', 'opacity-0'); }, 5000);
        }

        function updateClock() {
            const now = new Date();
            // Use Indonesian locale for formatting
            clockEl.textContent = now.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            dateEl.textContent = now.toLocaleDateString('id-ID', options);
        }

        // Password toggle (Updated to be more generic)
        pwdToggleBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const nowIsPassword = passwordInput.type === 'password';
            
            passwordInput.type = nowIsPassword ? 'text' : 'password';
            pwdToggleBtn.setAttribute('aria-pressed', String(nowIsPassword));
            
            // Update lucide icon
            const iconName = nowIsPassword ? 'eye-off' : 'eye';
            eyeIcon.setAttribute('data-lucide', iconName);
            window.lucide.createIcons();
            
            pwdToggleBtn.title = nowIsPassword ? 'Sembunyikan password' : 'Tampilkan password';
            
            try { passwordInput.focus(); const len = passwordInput.value.length; passwordInput.setSelectionRange(len, len); } catch(e){}
        });
        
        // Forgot password link action
        forgotPasswordLink.addEventListener('click', (e) => {
             e.preventDefault();
             const emailOrNisn = identifierInput.value.trim();
             if (!emailOrNisn.includes('@')) {
                 showMessage('Masukkan email Anda di kolom identitas untuk mengatur ulang password.', 'info');
                 return;
             }
             // NOTE: Password reset requires a backend function/full Supabase setup. 
             // For this demo, we'll just show a message.
             showMessage(`Permintaan reset password dikirim ke ${emailOrNisn}. (Fitur ini memerlukan konfigurasi Supabase)`, 'info');
        });


        // Auth helpers
        async function signInWithIdentifier(identifier, password) {
            if (!identifier) throw new Error('Masukkan email atau NISN.');
            if (!password) throw new Error('Masukkan password.');
            
            // 1. Email path
            if (identifier.includes('@')) {
                const { data, error } = await supabase.auth.signInWithPassword({ email: identifier, password });
                if (error) throw error;
                return data;
            }

            // 2. NISN path (10 digits)
            const nisn = identifier.trim();
            if (!/^\d{10}$/.test(nisn)) throw new Error('NISN harus 10 digit atau gunakan format email yang valid.');
            
            // Lookup email by NISN in 'profiles' table
            const { data: prof, error: pErr } = await supabase.from('profiles').select('email').eq('nisn', nisn).maybeSingle();
            
            if (pErr) console.error("NISN lookup error:", pErr);
            if (!prof?.email) throw new Error('NISN tidak ditemukan atau tidak terhubung dengan akun.');
            
            // Use the found email to sign in
            const { data, error } = await supabase.auth.signInWithPassword({ email: prof.email, password });
            if (error) throw error;
            return data;
        }

        async function refreshProfile() {
            const { data: userData } = await supabase.auth.getUser();
            const user = userData?.user || null;
            if (!user) return null;
            
            // Fetch profile data (full_name, avatar_url, nisn, etc.)
            const { data: profile, error } = await supabase.from('profiles')
                .select('id,full_name,email,avatar_url,nisn,class_id')
                .eq('id', user.id)
                .maybeSingle();
            
            if (error) console.warn('Gagal memuat profil', error);
            return { user, profile };
        }
        
        function getInitials(fullName) {
            if (!fullName) return '?';
            const parts = fullName.split(' ');
            if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
            return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
        }

        // Render UI
        async function renderSignedIn() {
            const { data: sessionData } = await supabase.auth.getSession();
            const user = sessionData?.session?.user;
            
            if (!user) {
                notSigned.classList.remove('hidden');
                signed.classList.add('hidden');
                return;
            }
            
            const res = await refreshProfile();
            const profile = res?.profile || {};
            
            notSigned.classList.add('hidden');
            signed.classList.remove('hidden');

            // Update profile info
            const name = profile.full_name || profile.nisn || (user.email || 'Pengguna');
            profileNameEl.textContent = name;
            profileEmailEl.textContent = user.email || '-';

            // Update avatar
            avatarEl.innerHTML = '';
            const initials = getInitials(name);

            if (profile.avatar_url) {
                avatarEl.style.backgroundImage = `url(${profile.avatar_url})`;
                avatarEl.style.backgroundColor = 'transparent';
                avatarEl.classList.remove('text-white');
                avatarEl.innerHTML = '';
            } else {
                // Use initials as fallback avatar
                avatarEl.style.backgroundImage = 'none';
                avatarEl.style.backgroundColor = '#6366f1'; // Indigo 500
                avatarEl.classList.add('text-white');
                avatarEl.textContent = initials;
                avatarEl.innerHTML = initials;
            }

            // Load attendance data
            await loadTodayAttendance(user.id);
        }

        // Attendance helpers
        function todayISO() { return new Date().toISOString().slice(0,10); }

        function formatTime(timeStr) {
            try {
                const parts = timeStr.split(':');
                if (parts.length >= 2) return `${parts[0]}:${parts[1]}`;
            } catch (e) {
                return timeStr;
            }
            return timeStr;
        }

        function createAttendanceRow(record) {
            const typeText = record.type === 'check_in' ? 'Masuk' : 'Pulang';
            let statusClass = 'text-yellow-600 bg-yellow-100';
            let statusIcon = 'alert-circle';
            
            if (record.status.includes('Tepat Waktu')) {
                statusClass = 'text-green-600 bg-green-100';
                statusIcon = 'check-circle';
            } else if (record.status.includes('Pulang Lebih Awal')) {
                 statusClass = 'text-red-600 bg-red-100';
                 statusIcon = 'x-circle';
            } else if (record.status.includes('Terlambat')) {
                 statusClass = 'text-yellow-600 bg-yellow-100';
                 statusIcon = 'alert-circle';
            }

            const timeFormatted = formatTime(record.log_time);

            return `
                <div class="flex items-center justify-between p-4 rounded-xl border border-gray-200 bg-white shadow-sm hover:shadow-md transition duration-150">
                    <div class="flex items-center gap-4">
                        <div class="p-2 rounded-full ${record.type === 'check_in' ? 'bg-indigo-100 text-indigo-600' : 'bg-pink-100 text-pink-600'}">
                            <i data-lucide="${record.type === 'check_in' ? 'clock-1' : 'clock-3'}" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <div class="font-bold text-gray-800">${typeText}</div>
                            <div class="text-xs text-gray-500">${timeFormatted}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <i data-lucide="${statusIcon}" class="w-4 h-4 ${record.status.includes('Tepat Waktu') ? 'text-green-500' : (record.status.includes('Terlambat') ? 'text-yellow-500' : 'text-red-500')}"></i>
                        <span class="text-sm font-medium px-2.5 py-0.5 rounded-full ${statusClass}">
                            ${record.status}
                        </span>
                    </div>
                </div>
            `;
        }


        async function loadTodayAttendance(user_id) {
            attendanceList.innerHTML = '';
            try {
                const { data, error } = await supabase.from('attendance_log')
                    .select('*')
                    .eq('user_id', user_id)
                    .eq('log_date', todayISO())
                    .order('log_time', { ascending: false });
                
                if (error) { console.error(error); showMessage('Gagal memuat absensi', 'error'); return; }

                if (!data || data.length === 0) {
                    attendanceList.innerHTML = '<div class="text-sm text-center text-gray-500 p-6 bg-gray-50 border border-dashed rounded-xl">Absensi Anda hari ini masih kosong. Silakan Absen Masuk.</div>';
                    checkinBtn.disabled = false;
                    checkoutBtn.disabled = true;
                } else {
                    data.reverse().forEach(r => { // Reverse to show check-in first
                        attendanceList.innerHTML += createAttendanceRow(r);
                    });
                    
                    window.lucide.createIcons(); // Re-render icons after adding new HTML
                    
                    const hasIn = data.some(x => x.type === 'check_in');
                    const hasOut = data.some(x => x.type === 'check_out');
                    
                    checkinBtn.disabled = hasIn;
                    checkoutBtn.disabled = (!hasIn) || hasOut;
                }
            } catch (err) {
                console.error(err);
                showMessage('Terjadi kesalahan saat memuat absensi', 'error');
            }
        }

        async function doAttendance(type) {
            const btn = type === 'check_in' ? checkinBtn : checkoutBtn;
            btn.disabled = true;
            try {
                const { data: sessionData } = await supabase.auth.getSession();
                const user = sessionData?.session?.user;
                if (!user) { showMessage('Anda harus login', 'error'); return; }

                const now = new Date();
                let status = '';
                
                // Define time limits for status in WIB/ID locale (assuming 7:15 AM check-in, 3:00 PM checkout)
                if (type === 'check_in') {
                    // Check-in time: before 7:15 AM
                    const checkinLimit = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 7, 15, 0);
                    status = now <= checkinLimit ? 'Tepat Waktu' : 'Terlambat';
                } else {
                    // Check-out time: after 3:00 PM
                    const checkoutLimit = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 15, 0, 0);
                    status = now >= checkoutLimit ? 'Pulang Tepat Waktu' : 'Pulang Lebih Awal';
                }

                // Log time in 'HH:MM:SS' format
                const logTime = now.toLocaleTimeString('en-US', { hour12: false, hour:'2-digit', minute:'2-digit', second:'2-digit' }); 

                const record = { user_id: user.id, type, status, log_time: logTime, log_date: todayISO() };
                
                const { error } = await supabase.from('attendance_log').insert(record);
                
                if (error) throw error;
                
                showMessage(`Absen ${type === 'check_in' ? 'Masuk' : 'Pulang'} tercatat: ${status}`, 'success');
                await loadTodayAttendance(user.id);

            } catch (err) {
                console.error(err);
                showMessage(err.message || 'Gagal mencatat absensi', 'error');
            } finally {
                // Re-enable is handled by loadTodayAttendance
                if (btn.disabled) btn.disabled = false; // Fallback in case load didn't run
            }
        }

        // UI wiring
        loginForm.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            loginBtn.disabled = true;
            const id = identifierInput.value.trim();
            const pwd = passwordInput.value;
            try {
                await signInWithIdentifier(id, pwd);
                await renderSignedIn();
                showMessage('Sukses masuk! Selamat bekerja/belajar.', 'success');
            } catch (err) {
                console.error(err);
                showMessage(err.message || 'Gagal login. Cek kembali NISN/Email dan Password.', 'error');
            } finally { loginBtn.disabled = false; }
        });

        signupBtn.addEventListener('click', async () => {
            const id = identifierInput.value.trim();
            const pwd = passwordInput.value;
            if (!id || !pwd) return showMessage('Isi Email & Password untuk daftar.', 'error');
            
            signupBtn.disabled = true;
            try {
                if (!id.includes('@')) throw new Error('Untuk pendaftaran, wajib menggunakan Email.');
                
                const { data, error } = await supabase.auth.signUp({ email: id, password: pwd });
                if (error) throw error;
                
                // Add initial profile, assuming sign-up was successful
                if (data.user) {
                   await supabase.from('profiles').insert({ id: data.user.id, email: id, full_name: 'Pengguna Baru' });
                }

                showMessage('Pendaftaran berhasil! Silakan login dengan akun Anda.', 'success');
            } catch (err) {
                console.error(err);
                showMessage(err.message || 'Gagal mendaftar', 'error');
            } finally { signupBtn.disabled = false; }
        });

        logoutBtn.addEventListener('click', async () => {
            await supabase.auth.signOut();
            notSigned.classList.remove('hidden');
            signed.classList.add('hidden');
            showMessage('Berhasil keluar. Sampai jumpa lagi!', 'info');
        });

        checkinBtn.addEventListener('click', () => doAttendance('check_in'));
        checkoutBtn.addEventListener('click', () => doAttendance('check_out'));

        // Initial boot and session listener
        (async function init(){
            // Start clock immediately and set interval
            updateClock();
            setInterval(updateClock, 1000);

            // Handle initial session check
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (session?.user) await renderSignedIn();
            } catch (e) {
                console.warn('init session check failed', e);
            }

            // session listener to keep UI in sync
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (session?.user && (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED')) { 
                    await renderSignedIn(); 
                }
                else if (event === 'SIGNED_OUT') {
                    notSigned.classList.remove('hidden'); 
                    signed.classList.add('hidden');
                }
            });
            
            // Initial Lucide icon rendering
            window.lucide.createIcons();
        })();
    </script>
</body>
</html>
