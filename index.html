<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistem Absensi — Supabase only</title>

  <!-- Supabase JS (only dependency) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    /* Minimal, dependency-free styling — easy to reason about in production */
    :root{
      --bg:#6b46c1;
      --accent:#7c3aed;
      --card:#ffffff;
      --muted:#6b7280;
      --success:#16a34a;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#5b21b6);color:#111}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:460px;background:var(--card);border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(2,6,23,0.12)}
    h1{margin:0 0 6px;font-size:24px;color:var(--bg)}
    p.lead{margin:0 0 18px;color:var(--muted);font-size:14px}
    label{display:block;font-weight:600;font-size:13px;margin-bottom:6px;color:#222}
    input[type="text"],input[type="password"],input[type="email"]{
      width:100%;padding:10px 12px;border:1px solid #e6e6e6;border-radius:8px;font-size:14px;box-sizing:border-box;
    }
    .row{margin-bottom:12px}
    .actions{display:flex;gap:8px;align-items:center}
    button.btn{background:linear-gradient(90deg,var(--bg),var(--accent));color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
    button.ghost{background:transparent;border:1px solid #e7e7e7;color:var(--muted);padding:8px 12px;border-radius:8px;cursor:pointer}
    .small{font-size:13px;color:var(--muted);margin-top:10px}
    .center{text-align:center}
    .status{padding:8px;border-radius:8px;background:#f3f4f6;border:1px solid #eee;margin-top:12px}
    .attendance-row{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-radius:8px;background:#fafafa;border:1px solid #f0f0f0;margin-top:8px}
    .muted{color:var(--muted)}
    .toggle-password{position:relative;display:inline-flex;align-items:center}
    .toggle-password button{position:absolute;right:6px;top:50%;transform:translateY(-50%);border:none;background:transparent;cursor:pointer;padding:6px;border-radius:6px}
    .hidden{display:none}
    .profile{display:flex;gap:12px;align-items:center}
    .avatar{width:40px;height:40px;border-radius:8px;background:#eee;display:inline-block}
    .danger{background:#fee2e2;color:#991b1b;padding:8px;border-radius:8px;margin-top:12px}
    footer{margin-top:18px;text-align:center;color:#fff;font-size:12px}
    @media (max-width:480px){ .card{padding:16px} h1{font-size:20px} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="app">
      <div id="not-signed-in">
        <h1>Sistem Absensi</h1>
        <p class="lead">Masuk menggunakan Email atau NISN + Password (Supabase only)</p>

        <form id="login-form" autocomplete="on">
          <div class="row">
            <label for="identifier">Email atau NISN</label>
            <input id="identifier" name="identifier" type="text" inputmode="email" placeholder="email@domain.com atau 10 digit NISN" />
          </div>

          <div class="row toggle-password" style="position:relative">
            <label for="password">Password</label>
            <input id="password" name="password" type="password" placeholder="Masukkan password" />
            <button type="button" id="pwd-toggle" aria-pressed="false" title="Tampilkan password">
              <!-- simple inline icons -->
              <svg id="eye-open" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#444" stroke-width="1.6" xmlns="http://www.w3.org/2000/svg">
                <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7S2 12 2 12z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              <svg id="eye-closed" class="hidden" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#444" stroke-width="1.6" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 3l18 18M10.6 10.6a3 3 0 014.2 4.2"/>
                <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7S2 12 2 12z"/>
              </svg>
            </button>
          </div>

          <div class="row actions">
            <button id="login-btn" class="btn" type="submit">Masuk</button>
            <button id="signup-btn" class="ghost" type="button">Daftar (opsional)</button>
          </div>
        </form>

        <div class="small center muted">Atau masuk dengan NISN (10 digit) — client will resolve to email</div>
      </div>

      <div id="signed-in" class="hidden">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="profile">
            <div class="avatar" id="avatar"></div>
            <div>
              <div id="profile-name" style="font-weight:700"></div>
              <div class="muted" id="profile-email"></div>
            </div>
          </div>
          <div>
            <button id="logout-btn" class="ghost">Keluar</button>
          </div>
        </div>

        <div class="status">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:700" id="clock">00:00:00</div>
              <div class="muted" id="date">-</div>
            </div>
            <div style="display:flex;gap:8px">
              <button id="checkin" class="btn">Absen Masuk</button>
              <button id="checkout" class="btn">Absen Pulang</button>
            </div>
          </div>

          <div id="attendance-list" style="margin-top:12px"></div>
        </div>

        <div class="small muted" style="margin-top:10px">
          Signed in with Supabase. All requests go to your Supabase project.
        </div>
      </div>

      <div id="messages" class="hidden" style="margin-top:12px"></div>
      <footer>Supabase only demo — no other libraries</footer>
    </div>
  </div>

  <script>
    // ---------- CONFIG: Replace with your Supabase URL and anon key ----------
    const SUPABASE_URL = 'https://qvunfkabbhulwqfnkren.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2dW5ma2FiYmh1bHdxZm5rcmVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNzkyOTksImV4cCI6MjA3NDg1NTI5OX0.2x_cwD11T4birj0NnAqzCqS_AtfZLqr65yb7ioV04IY';
    // ----------------------------------------------------------------------

    const supabase = supabaseJs.createClient
      ? supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) // modern UMD variable
      : window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // fallback if global var name differs

    // DOM
    const app = document.getElementById('app');
    const notSigned = document.getElementById('not-signed-in');
    const signed = document.getElementById('signed-in');
    const messages = document.getElementById('messages');

    const loginForm = document.getElementById('login-form');
    const identifierInput = document.getElementById('identifier');
    const passwordInput = document.getElementById('password');
    const loginBtn = document.getElementById('login-btn');
    const signupBtn = document.getElementById('signup-btn');

    const pwdToggleBtn = document.getElementById('pwd-toggle');
    const eyeOpen = document.getElementById('eye-open');
    const eyeClosed = document.getElementById('eye-closed');

    const avatarEl = document.getElementById('avatar');
    const profileNameEl = document.getElementById('profile-name');
    const profileEmailEl = document.getElementById('profile-email');
    const logoutBtn = document.getElementById('logout-btn');

    const checkinBtn = document.getElementById('checkin');
    const checkoutBtn = document.getElementById('checkout');
    const attendanceList = document.getElementById('attendance-list');

    const clockEl = document.getElementById('clock');
    const dateEl = document.getElementById('date');

    // small helpers
    function show(msg, type='info') {
      messages.classList.remove('hidden');
      messages.textContent = msg;
      messages.className = type === 'error' ? 'danger' : '';
      setTimeout(()=>{ messages.classList.add('hidden'); messages.textContent=''; }, 4000);
    }

    function updateClock() {
      const now = new Date();
      clockEl.textContent = now.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
      const days = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
      const months = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
      dateEl.textContent = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
    }

    // Password toggle
    pwdToggleBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const isPwd = passwordInput.type === 'password';
      passwordInput.type = isPwd ? 'text' : 'password';
      pwdToggleBtn.setAttribute('aria-pressed', String(isPwd));
      // show/ hide icons based on new state
      if (isPwd) { eyeOpen.classList.add('hidden'); eyeClosed.classList.remove('hidden'); pwdToggleBtn.title = 'Sembunyikan password'; }
      else { eyeOpen.classList.remove('hidden'); eyeClosed.classList.add('hidden'); pwdToggleBtn.title = 'Tampilkan password'; }
      // keep focus / caret
      try { passwordInput.focus(); const len = passwordInput.value.length; passwordInput.setSelectionRange(len,len); } catch(e){}
    });

    //--------------- Auth helpers ----------------
    async function signInWithIdentifier(identifier, password) {
      // If identifier looks like an email -> use directly; otherwise treat as NISN (10 digits)
      if (identifier.includes('@')) {
        return await supabase.auth.signInWithPassword({ email: identifier, password });
      } else {
        // NISN path: lookup profile by nisn to get email
        const nisn = identifier.trim();
        if (!/^\d{10}$/.test(nisn)) {
          throw new Error('NISN harus 10 digit atau gunakan email.');
        }
        const { data: prof, error: pErr } = await supabase.from('profiles').select('email').eq('nisn', nisn).single();
        if (pErr || !prof?.email) throw new Error('NISN tidak ditemukan.');
        return await supabase.auth.signInWithPassword({ email: prof.email, password });
      }
    }

    async function refreshProfile() {
      const user = supabase.auth.getUser ? (await supabase.auth.getUser()).data.user : null;
      // For supabase-js v2: use getUser(); if unavailable, try session listener.
      if (!user) return null;
      const { data: profile, error } = await supabase.from('profiles').select('id,full_name,email,avatar_url,nisn,class_id').eq('id', user.id).maybeSingle();
      if (error) console.warn('profile fetch error', error);
      return { user, profile };
    }

    // render sign-in state
    async function renderSignedIn() {
      const { data: { user } } = await supabase.auth.getSession();
      if (!user) {
        notSigned.classList.remove('hidden');
        signed.classList.add('hidden');
        return;
      }
      const res = await refreshProfile();
      const profile = res?.profile || {};
      notSigned.classList.add('hidden');
      signed.classList.remove('hidden');
      profileNameEl.textContent = profile.full_name || profile.nisn || (user.email || '');
      profileEmailEl.textContent = user.email || '';
      if (profile.avatar_url) avatarEl.style.backgroundImage = `url(${profile.avatar_url})`;
      else avatarEl.style.backgroundImage = '';
      updateClock();
      setInterval(updateClock, 1000);
      await loadTodayAttendance(user.id);
    }

    // attendance functions
    function todayISO() {
      return new Date().toISOString().slice(0,10);
    }

    async function loadTodayAttendance(user_id) {
      attendanceList.innerHTML = '';
      try {
        const { data, error } = await supabase.from('attendance_log').select('*').eq('user_id', user_id).eq('log_date', todayISO()).order('log_time', { ascending: false });
        if (error) { console.warn(error); return; }
        if (!data || data.length === 0) {
          attendanceList.innerHTML = '<div class="muted small">Belum ada riwayat absensi hari ini</div>';
          checkinBtn.disabled = false;
          checkoutBtn.disabled = true;
        } else {
          data.forEach(r => {
            const d = document.createElement('div');
            d.className = 'attendance-row';
            d.innerHTML = `<div><strong>${r.type === 'check_in' ? 'Absen Masuk' : 'Absen Pulang'}</strong><div class="muted" style="font-size:13px">${r.log_time} — ${r.status || ''}</div></div>`;
            attendanceList.appendChild(d);
          });
          // set buttons based on presence
          const hasIn = data.some(x => x.type === 'check_in');
          const hasOut = data.some(x => x.type === 'check_out');
          checkinBtn.disabled = hasIn;
          checkoutBtn.disabled = (!hasIn) || hasOut;
        }
      } catch (err) {
        console.error(err);
      }
    }

    async function doAttendance(type) {
      try {
        const { data: { user } } = await supabase.auth.getSession();
        if (!user) { show('Anda harus login', 'error'); return; }
        const now = new Date();
        let status = '';
        if (type === 'check_in') status = (now.getHours() < 7 || (now.getHours() === 7 && now.getMinutes() <= 15)) ? 'Tepat Waktu' : 'Terlambat';
        else status = now.getHours() >= 15 ? 'Pulang Tepat Waktu' : 'Pulang Lebih Awal';
        const record = { user_id: user.id, type, status, log_time: now.toTimeString().slice(0,8), log_date: todayISO() };
        const { error } = await supabase.from('attendance_log').insert(record);
        if (error) throw error;
        show('Absensi tercatat', 'success');
        await loadTodayAttendance(user.id);
      } catch (err) {
        console.error(err);
        show(err.message || 'Gagal mencatat absensi', 'error');
      }
    }

    // wire UI
    loginForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      loginBtn.disabled = true;
      const id = identifierInput.value.trim();
      const pwd = passwordInput.value;
      try {
        await signInWithIdentifier(id, pwd);
        // supabase emits session; we read session and render
        await renderSignedIn();
        show('Sukses masuk', 'success');
      } catch (err) {
        console.error(err);
        show(err.message || 'Gagal login', 'error');
      } finally { loginBtn.disabled = false; }
    });

    signupBtn.addEventListener('click', async () => {
      // Optional quick signup: create user with email/password and create profile with nisn if provided.
      const id = identifierInput.value.trim();
      const pwd = passwordInput.value;
      if (!id || !pwd) return show('Isi identifier & password untuk daftar', 'error');

      try {
        // if user provided NISN (10 digits) but not email — we cannot create user without email.
        if (!id.includes('@')) return show('Untuk pendaftaran gunakan email. Anda bisa masuk dengan NISN setelah admin menautkan email.', 'error');

        const { data, error } = await supabase.auth.signUp({ email: id, password: pwd });
        if (error) throw error;
        // On success, create profile row with nisn if an extra field exists (not mandatory here).
        show('Pendaftaran berhasil. Cek email untuk verifikasi jika diperlukan.', 'success');
      } catch (err) {
        console.error(err);
        show(err.message || 'Gagal mendaftar', 'error');
      }
    });

    logoutBtn.addEventListener('click', async () => {
      await supabase.auth.signOut();
      notSigned.classList.remove('hidden');
      signed.classList.add('hidden');
    });

    checkinBtn.addEventListener('click', () => doAttendance('check_in'));
    checkoutBtn.addEventListener('click', () => doAttendance('check_out'));

    // session listener — keep UI in sync
    if (supabase.auth.onAuthStateChange) {
      supabase.auth.onAuthStateChange(async (event, session) => {
        if (session?.user) {
          await renderSignedIn();
        } else {
          notSigned.classList.remove('hidden');
          signed.classList.add('hidden');
        }
      });
    }

    // initial check
    (async function init(){
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (session?.user) await renderSignedIn();
      } catch (e) {
        console.warn('init session check failed', e);
      }
      updateClock();
      setInterval(updateClock,1000);
    })();
  </script>
</body>
</html>
