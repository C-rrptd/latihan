<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistem Absensi Sekolah Online</title>

  <!-- Use compiled Tailwind CSS (production) instead of the CDN -->
  <link rel="stylesheet" href="/dist/styles.css">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root { --primary-from: #667eea; --primary-to: #764ba2; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(135deg, var(--primary-from) 0%, var(--primary-to) 100%);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Glass card */
    .glass {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.22);
      box-shadow: 0 10px 30px rgba(2,6,23,0.08);
    }

    .gradient-text {
      background: linear-gradient(135deg, var(--primary-from) 0%, var(--primary-to) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      color: transparent;
    }

    /* spinner */
    .spinner, .btn-spinner {
      border-radius: 9999px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: var(--primary-from);
      animation: spin 1s linear infinite;
    }
    .spinner { width: 48px; height: 48px; }
    .btn-spinner { width: 22px; height: 22px; border-width: 3px; border-top-color: #fff; }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* toggle-password button */
    .toggle-password {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 3rem;      /* 48px hit area */
      height: 3rem;
      background: transparent;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      color: #6b7280;
      border-radius: .5rem;
      z-index: 40;
    }
    .toggle-password:focus {
      outline: none;
      box-shadow: 0 0 0 4px rgba(102,126,234,0.12);
    }
    .toggle-password .icon {
      width: 1.25rem;   /* 20px */
      height: 1.25rem;
      display: block;
      pointer-events: none;
    }

    /* ensure inputs with toggles have enough padding */
    .has-password-toggle { padding-right: 4rem !important; } /* ~64px */

    /* toast */
    #toast { position: fixed; right: 1.25rem; bottom: 1.5rem; z-index: 60; transition: all .25s ease; opacity: 0; transform: translateY(10px); }
    #toast.show { opacity: 1; transform: translateY(0); }

    /* responsiveness tweaks */
    @media (max-width: 640px) {
      .toggle-password { width: 2.5rem; height: 2.5rem; }
      .has-password-toggle { padding-right: 3.5rem !important; }
    }
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loading-screen" class="fixed inset-0 flex items-center justify-center z-50 hidden" aria-hidden="true">
    <div class="bg-gradient-to-br from-purple-700 to-indigo-700 w-full h-full absolute opacity-80"></div>
    <div class="relative z-60 flex flex-col items-center gap-4">
      <div class="spinner"></div>
      <p class="text-white font-semibold">Memuat...</p>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Auth page -->
  <main id="login-page" class="min-h-screen flex items-start justify-center py-12 px-4">
    <div class="w-full max-w-md">
      <div class="text-center mb-8">
        <!-- inline book icon -->
        <div class="mx-auto w-20 h-20 bg-white rounded-2xl shadow-lg flex items-center justify-center mb-4">
          <svg class="w-10 h-10 text-purple-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
            <path d="M3 5a2 2 0 012-2h2l2 2h6l2-2h2a2 2 0 012 2v13a1 1 0 01-1 1H4a1 1 0 01-1-1V5z"></path>
            <path d="M7 7v12"></path>
          </svg>
        </div>

        <h1 class="text-4xl font-extrabold text-white gradient-text">Selamat Datang</h1>
        <p class="text-purple-100 mt-2">Masuk ke Sistem Absensi Sekolah</p>
      </div>

      <div class="glass rounded-2xl p-6 shadow-xl">
        <form id="login-form" class="space-y-5" autocomplete="on" novalidate>
          <div>
            <label for="identifier" class="block text-sm font-semibold text-gray-700 mb-2">Email atau NISN</label>
            <input id="identifier" name="identifier" type="text" required
                   class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-200"
                   placeholder="email@domain.com atau 10 digit NISN" />
          </div>

          <div class="relative">
            <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
            <input id="password" name="password" type="password" required
                   class="w-full has-password-toggle px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-200"
                   placeholder="Masukkan password" autocomplete="current-password" />

            <!-- Toggle: data-action used to avoid conflicts -->
            <button type="button" class="toggle-password" data-action="toggle-password" data-target="password" aria-label="Tampilkan password" aria-pressed="false" title="Tampilkan password">
              <!-- eye open (visible when input.type === 'password') -->
              <svg class="icon eye-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
                <path d="M2.5 12s3.5-7.5 9.5-7.5S21.5 12 21.5 12 18 19.5 12 19.5 2.5 12 2.5 12z"/>
                <circle cx="12" cy="12" r="3.2"/>
              </svg>
              <!-- eye closed (hidden by default) -->
              <svg class="icon eye-closed hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
                <path d="M3 3l18 18"/>
                <path d="M10.6 10.6a3 3 0 014.2 4.2" />
                <path d="M2.6 12s3.5-7.5 9.5-7.5c2 0 3.7.6 5 1.6" />
                <path d="M21.4 12s-3.5 7.5-9.5 7.5c-2 0-3.7-.6-5-1.6" />
              </svg>
            </button>
          </div>

          <div>
            <button id="login-submit" type="submit"
                    class="w-full btn-primary text-white font-bold py-3 rounded-xl shadow-md hover:shadow-lg transition-all"
                    style="background: linear-gradient(135deg,var(--primary-from),var(--primary-to));">
              Masuk
            </button>
          </div>
        </form>

        <div class="mt-6 text-center">
          <button id="show-forgot-password-button" class="text-sm text-purple-100 hover:text-white transition-colors">Lupa password?</button>
          <p class="mt-3 text-sm text-purple-100">Belum punya akun? <button id="show-signup-button" class="underline font-semibold text-white">Daftar di sini</button></p>
        </div>
      </div>
    </div>
  </main>

  <!-- Main app container (hidden initially) -->
  <div id="main-app" class="hidden min-h-screen bg-gray-50">
    <header class="glass sticky top-0 z-40 border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-gradient-to-br from-purple-600 to-indigo-600 rounded-xl flex items-center justify-center shadow">
            <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 10.5L12 6l9 4.5"/><path d="M12 6v13"/></svg>
          </div>
          <div>
            <h1 class="text-xl font-bold gradient-text">Sistem Absensi</h1>
            <p class="text-sm text-gray-600">Selamat datang, <span id="welcome-message" class="font-semibold"></span></p>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button id="profile-button" class="flex items-center gap-2 px-3 py-2 bg-purple-100 text-purple-700 rounded-xl hover:bg-purple-200 transition-all">
            <div class="w-8 h-8 rounded-lg overflow-hidden bg-purple-200 flex items-center justify-center">
              <svg class="w-4 h-4 text-purple-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0z"/><path d="M4 21v-1a4 4 0 014-4h8a4 4 0 014 4v1"/></svg>
            </div>
            <span class="hidden sm:inline font-semibold">Profil</span>
          </button>

          <button id="logout-button" class="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-all">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M17 16l4-4-4-4"/><path d="M21 12H7"/><path d="M7 20H5a2 2 0 01-2-2V6a2 2 0 012-2h2"/></svg>
            <span class="hidden sm:inline">Keluar</span>
          </button>
        </div>
      </div>
    </header>

    <section class="max-w-7xl mx-auto p-6 space-y-6">
      <!-- Dashboard simplified for brevity -->
      <div class="glass rounded-2xl p-8 text-center">
        <h2 id="clock" class="text-5xl font-extrabold gradient-text mb-2">00:00:00</h2>
        <p id="date" class="text-gray-600 mb-6">-</p>
        <div class="flex gap-4 justify-center">
          <button id="check-in-button" class="px-8 py-3 btn-primary text-white rounded-xl shadow">Absen Masuk</button>
          <button id="check-out-button" class="px-8 py-3 btn-primary text-white rounded-xl shadow">Absen Pulang</button>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="glass rounded-2xl p-6">Riwayat Absensi Hari Ini</div>
        <div class="glass rounded-2xl p-6">Jadwal Pelajaran</div>
      </div>
    </section>
  </div>

  <script>
    // --- Supabase client (same keys used previously) ---
    const supabaseClient = supabase.createClient(
      'https://qvunfkabbhulwqfnkren.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2dW5ma2FiYmh1bHdxZm5rcmVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNzkyOTksImV4cCI6MjA3NDg1NTI5OX0.2x_cwD11T4birj0NnAqzCqS_AtfZLqr65yb7ioV04IY'
    );

    // lightweight utilities
    const appState = {
      currentUser: null,
      profile: null,
      clockInterval: null,
      loadingTimeout: null
    };

    function showLoading(on = true) {
      const el = document.getElementById('loading-screen');
      if (!el) return;
      el.classList.toggle('hidden', !on);
      if (appState.loadingTimeout) { clearTimeout(appState.loadingTimeout); appState.loadingTimeout = null; }
      if (on) {
        appState.loadingTimeout = setTimeout(() => {
          el.classList.add('hidden');
          appState.loadingTimeout = null;
        }, 20000);
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      if (!toast) return;
      const colors = { success: 'bg-emerald-500', error: 'bg-red-500', info: 'bg-blue-500' };
      const icon = type === 'success' ? '✔' : (type === 'error' ? '⚠' : 'ℹ');
      toast.className = `text-white px-4 py-3 rounded shadow-lg ${colors[type]} show`;
      toast.innerHTML = `<div class="flex items-center gap-3"><div class="text-xl">${icon}</div><div>${message}</div></div>`;
      toast.classList.add('show');
      setTimeout(() => { toast.classList.remove('show'); }, 3500);
    }

    // Clock
    function updateClock() {
      const clock = document.getElementById('clock');
      const dateEl = document.getElementById('date');
      if (!clock || !dateEl) return;
      const now = new Date();
      clock.textContent = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      const days = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
      const months = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
      dateEl.textContent = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
    }

    // --- PASSWORD TOGGLE HANDLING ---
    // Use event delegation; works even if DOM changes
    document.addEventListener('click', (ev) => {
      const btn = ev.target.closest('[data-action="toggle-password"]');
      if (!btn) return;
      ev.preventDefault();
      ev.stopPropagation();

      try {
        const targetId = btn.getAttribute('data-target');
        const input = targetId ? document.getElementById(targetId) : btn.closest('.relative')?.querySelector('input[type="password"], input[type="text"]');
        if (!input) {
          console.warn('toggle: no target input found for', btn);
          return;
        }

        const isPassword = input.type === 'password';
        input.type = isPassword ? 'text' : 'password';
        btn.setAttribute('aria-pressed', String(isPassword));
        btn.title = isPassword ? 'Sembunyikan password' : 'Tampilkan password';

        const eyeOpen = btn.querySelector('.eye-open');
        const eyeClosed = btn.querySelector('.eye-closed');
        if (eyeOpen) eyeOpen.classList.toggle('hidden', !isPassword);
        if (eyeClosed) eyeClosed.classList.toggle('hidden', isPassword);

        // restore focus/caret
        try {
          input.focus();
          const len = input.value?.length || 0;
          input.setSelectionRange(len, len);
        } catch (e) { /* ignore */ }
      } catch (err) {
        console.error('Error toggling password:', err);
      }
    });

    // --- AUTH + UI wiring (kept minimal & similar to your previous flow) ---
    async function initializeMainApp(user) {
      if (!user) return;
      if (appState.currentUser && appState.currentUser.id === user.id) return;
      appState.currentUser = user;
      showLoading(true);
      try {
        const { data: profile, error } = await supabaseClient.from('profiles').select('*, classes(class_name)').eq('id', user.id).maybeSingle();
        if (error && error.code !== 'PGRST116') throw error;
        appState.profile = profile || null;
        document.getElementById('welcome-message').textContent = appState.profile?.full_name || appState.profile?.nisn || user.email?.split('@')[0] || 'User';

        // show main app
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');

        // start clock for students
        if (appState.clockInterval) clearInterval(appState.clockInterval);
        updateClock();
        appState.clockInterval = setInterval(updateClock, 1000);
      } catch (err) {
        console.error('initializeMainApp error', err);
        showToast('Gagal memuat aplikasi', 'error');
      } finally {
        showLoading(false);
      }
    }

    async function handleLogin(e) {
      e.preventDefault();
      const form = e.target;
      const submit = form.querySelector('button[type="submit"]');
      const id = form.querySelector('[name="identifier"]').value?.trim();
      const pwd = form.querySelector('[name="password"]').value;
      if (!id || !pwd) { showToast('Email/NISN & password wajib diisi', 'error'); return; }

      showLoading(true);
      try {
        let email = id;
        if (!id.includes('@')) {
          // treat as NISN
          if (!/^\d{10}$/.test(id)) throw new Error('NISN harus 10 digit');
          const { data: p, error: pErr } = await supabaseClient.from('profiles').select('email').eq('nisn', id).single();
          if (pErr || !p) throw new Error('NISN tidak ditemukan');
          email = p.email;
        }
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password: pwd });
        if (error) throw error;
        if (!data.user) throw new Error('Login gagal');
        await initializeMainApp(data.user);
        showToast('Berhasil masuk', 'success');
      } catch (err) {
        console.error('login error', err);
        showToast(err.message || 'Gagal login', 'error');
      } finally { showLoading(false); }
    }

    async function handleLogout() {
      try {
        await supabaseClient.auth.signOut();
      } catch (err) { console.warn(err); }
      appState.currentUser = null;
      appState.profile = null;
      if (appState.clockInterval) { clearInterval(appState.clockInterval); appState.clockInterval = null; }
      document.getElementById('main-app').classList.add('hidden');
      document.getElementById('login-page').classList.remove('hidden');
    }

    // DOM ready wiring
    document.addEventListener('DOMContentLoaded', async () => {
      // wire form
      document.getElementById('login-form').addEventListener('submit', handleLogin);

      // nav buttons
      document.getElementById('logout-button')?.addEventListener('click', handleLogout);

      // quick check for existing session
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session?.user) await initializeMainApp(session.user);
      } catch (err) {
        console.warn('getSession:', err);
      }
    });

    // keep clock accurate on visibility
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) updateClock();
    });
  </script>
</body>
</html>
