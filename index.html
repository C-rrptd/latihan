<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistem Absensi Sekolah Online</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root { --from: #667eea; --to: #764ba2; }
    * { box-sizing: border-box; }
    body {
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, var(--from) 0%, var(--to) 100%);
    }

    .glass {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.22);
      box-shadow: 0 10px 30px rgba(2,6,23,0.08);
    }

    .gradient-text {
      background: linear-gradient(135deg, var(--from), var(--to));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* spinner */
    .spinner { border-radius: 9999px; border: 4px solid rgba(255,255,255,0.3); border-top-color: var(--from); width: 48px; height: 48px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* toggle button */
    .toggle-password {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 3rem;   /* large hit area */
      height: 3rem;
      background: transparent;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      color: #6b7280;
      border-radius: 0.5rem;
      z-index: 50;   /* ensure it's above input */
    }
    .toggle-password:focus {
      outline: none;
      box-shadow: 0 0 0 4px rgba(102,126,234,0.12);
    }
    .toggle-password .icon { width: 1.3rem; height: 1.3rem; pointer-events: none; display:block; }

    /* ensure inputs with toggles have room */
    .has-password-toggle { padding-right: 4rem !important; }

    /* toast */
    #toast { position: fixed; right: 1rem; bottom: 1.25rem; z-index: 60; transition: all .25s ease; opacity: 0; transform: translateY(8px); }
    #toast.show { opacity: 1; transform: translateY(0); }

    @media (max-width: 640px) {
      .toggle-password { width: 2.5rem; height: 2.5rem; }
      .has-password-toggle { padding-right: 3.5rem !important; }
    }
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loading-screen" class="fixed inset-0 flex items-center justify-center z-50 hidden" aria-hidden="true">
    <div class="absolute inset-0 bg-gradient-to-br from-purple-700 to-indigo-700 opacity-80"></div>
    <div class="relative z-10 flex flex-col items-center gap-4">
      <div class="spinner"></div>
      <p class="text-white font-semibold">Memuat...</p>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- Login page -->
  <main id="login-page" class="min-h-screen flex items-start justify-center py-12 px-4">
    <div class="w-full max-w-md">
      <div class="text-center mb-8">
        <div class="mx-auto w-20 h-20 bg-white rounded-2xl shadow-lg flex items-center justify-center mb-4">
          <svg class="w-10 h-10 text-purple-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 5a2 2 0 012-2h2l2 2h6l2-2h2a2 2 0 012 2v13a1 1 0 01-1 1H4a1 1 0 01-1-1V5z"/><path d="M7 7v12"/></svg>
        </div>

        <h1 class="text-4xl font-extrabold text-white gradient-text">Selamat Datang</h1>
        <p class="text-purple-100 mt-2">Masuk ke Sistem Absensi Sekolah</p>
      </div>

      <div class="glass rounded-2xl p-6 shadow-xl">
        <form id="login-form" class="space-y-5" autocomplete="on" novalidate>
          <div>
            <label for="identifier" class="block text-sm font-semibold text-gray-700 mb-2">Email atau NISN</label>
            <input id="identifier" name="identifier" type="text" required
                   class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-200"
                   placeholder="email@domain.com atau 10 digit NISN" />
          </div>

          <div class="relative">
            <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
            <input id="password" name="password" type="password" required
                   class="w-full has-password-toggle px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-200"
                   placeholder="Masukkan password" autocomplete="current-password" />

            <!-- Single toggle button (login) -->
            <button type="button" class="toggle-password" data-action="toggle-password" data-target="password" aria-label="Tampilkan password" aria-pressed="false" title="Tampilkan password">
              <!-- eye open (visible when password is hidden) -->
              <svg class="icon eye-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
                <path d="M2.5 12s3.5-7.5 9.5-7.5S21.5 12 21.5 12 18 19.5 12 19.5 2.5 12 2.5 12z"/>
                <circle cx="12" cy="12" r="3.2"/>
              </svg>

              <!-- eye closed (hidden initially) -->
              <svg class="icon eye-closed hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" aria-hidden="true">
                <path d="M3 3l18 18"/>
                <path d="M10.6 10.6a3 3 0 014.2 4.2" />
                <path d="M2.6 12s3.5-7.5 9.5-7.5c2 0 3.7.6 5 1.6" />
                <path d="M21.4 12s-3.5 7.5-9.5 7.5c-2 0-3.7-.6-5-1.6" />
              </svg>
            </button>
          </div>

          <div>
            <button id="login-submit" type="submit"
                    class="w-full font-bold py-3 rounded-xl shadow-md text-white"
                    style="background: linear-gradient(135deg,var(--from),var(--to));">
              Masuk
            </button>
          </div>
        </form>

        <div class="mt-6 text-center">
          <button id="show-forgot-password-button" class="text-sm text-purple-100 hover:text-white transition-colors">Lupa password?</button>
          <p class="mt-3 text-sm text-purple-100">Belum punya akun? <button id="show-signup-button" class="underline font-semibold text-white">Daftar di sini</button></p>
        </div>
      </div>
    </div>
  </main>

  <!-- Main app container (hidden initially) -->
  <div id="main-app" class="hidden min-h-screen bg-gray-50">
    <header class="glass sticky top-0 z-40 border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-gradient-to-br from-purple-600 to-indigo-600 rounded-xl flex items-center justify-center shadow">
            <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M3 10.5L12 6l9 4.5"/><path d="M12 6v13"/></svg>
          </div>
          <div>
            <h1 class="text-xl font-bold gradient-text">Sistem Absensi</h1>
            <p class="text-sm text-gray-600">Selamat datang, <span id="welcome-message" class="font-semibold"></span></p>
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button id="profile-button" class="flex items-center gap-2 px-3 py-2 bg-purple-100 text-purple-700 rounded-xl hover:bg-purple-200 transition-all">
            <div class="w-8 h-8 rounded-lg overflow-hidden bg-purple-200 flex items-center justify-center">
              <svg class="w-4 h-4 text-purple-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0z"/><path d="M4 21v-1a4 4 0 014-4h8a4 4 0 014 4v1"/></svg>
            </div>
            <span class="hidden sm:inline font-semibold">Profil</span>
          </button>

          <button id="logout-button" class="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-all">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M17 16l4-4-4-4"/><path d="M21 12H7"/><path d="M7 20H5a2 2 0 01-2-2V6a2 2 0 012-2h2"/></svg>
            <span class="hidden sm:inline">Keluar</span>
          </button>
        </div>
      </div>
    </header>

    <section class="max-w-7xl mx-auto p-6 space-y-6">
      <div class="glass rounded-2xl p-8 text-center">
        <h2 id="clock" class="text-5xl font-extrabold gradient-text mb-2">00:00:00</h2>
        <p id="date" class="text-gray-600 mb-6">-</p>
        <div class="flex gap-4 justify-center">
          <button id="check-in-button" class="px-8 py-3 font-semibold rounded-xl text-white" style="background: linear-gradient(135deg,var(--from),var(--to));">Absen Masuk</button>
          <button id="check-out-button" class="px-8 py-3 font-semibold rounded-xl text-white" style="background: linear-gradient(135deg,var(--from),var(--to));">Absen Pulang</button>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="glass rounded-2xl p-6">Riwayat Absensi Hari Ini</div>
        <div class="glass rounded-2xl p-6">Jadwal Pelajaran</div>
      </div>
    </section>
  </div>

  <script>
    // Supabase client
    const supabaseClient = supabase.createClient(
      'https://qvunfkabbhulwqfnkren.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2dW5ma2FiYmh1bHdxZm5rcmVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNzkyOTksImV4cCI6MjA3NDg1NTI5OX0.2x_cwD11T4birj0NnAqzCqS_AtfZLqr65yb7ioV04IY'
    );

    // small helpers
    function showLoading(on = true) {
      const el = document.getElementById('loading-screen');
      if (!el) return;
      el.classList.toggle('hidden', !on);
    }

    function showToast(msg, type='info') {
      const toast = document.getElementById('toast');
      if (!toast) return;
      const colors = { success: 'bg-emerald-500', error: 'bg-red-500', info: 'bg-blue-500' };
      toast.className = `${colors[type]} text-white px-4 py-3 rounded shadow show`;
      toast.innerHTML = `<div class="flex items-center gap-3">${msg}</div>`;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Toggle handler: use event delegation and update icons based on NEW input.type
    document.addEventListener('click', (ev) => {
      const btn = ev.target.closest('[data-action="toggle-password"]');
      if (!btn) return;
      ev.preventDefault();
      ev.stopPropagation();

      const targetId = btn.getAttribute('data-target');
      const input = targetId ? document.getElementById(targetId) : btn.closest('.relative')?.querySelector('input[type="password"], input[type="text"]');
      if (!input) { console.warn('toggle: target input not found'); return; }

      // flip type
      input.type = (input.type === 'password') ? 'text' : 'password';

      // After change, update icons based on the new type
      const nowIsPassword = input.type === 'password';
      btn.setAttribute('aria-pressed', String(!nowIsPassword));
      btn.title = nowIsPassword ? 'Tampilkan password' : 'Sembunyikan password';

      const eyeOpen = btn.querySelector('.eye-open');
      const eyeClosed = btn.querySelector('.eye-closed');

      if (eyeOpen) eyeOpen.classList.toggle('hidden', !nowIsPassword);   // show eye-open when type=password (hidden)
      if (eyeClosed) eyeClosed.classList.toggle('hidden', nowIsPassword); // show eye-closed when type=text (visible)

      // keep focus and move caret to end
      try {
        input.focus();
        const len = input.value?.length || 0;
        input.setSelectionRange(len, len);
      } catch (e) { /* ignore */ }

      console.debug('Password toggle clicked â€” input type is now', input.type);
    });

    // Clock & simple auth wiring (minimal)
    function updateClock() {
      const clock = document.getElementById('clock');
      const dateEl = document.getElementById('date');
      if (!clock || !dateEl) return;
      const now = new Date();
      clock.textContent = now.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
      const days = ["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
      const months = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
      dateEl.textContent = `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
    }

    async function initializeMainApp(user) {
      if (!user) return;
      document.getElementById('login-page').classList.add('hidden');
      document.getElementById('main-app').classList.remove('hidden');
      updateClock();
      setInterval(updateClock, 1000);
    }

    async function handleLogin(e) {
      e.preventDefault();
      const id = document.getElementById('identifier').value.trim();
      const pwd = document.getElementById('password').value;
      if (!id || !pwd) { showToast('Email/NISN & password wajib diisi', 'error'); return; }
      showLoading(true);
      try {
        let email = id;
        if (!id.includes('@')) {
          if (!/^\d{10}$/.test(id)) throw new Error('NISN harus 10 digit');
          const { data: profile, error } = await supabaseClient.from('profiles').select('email').eq('nisn', id).single();
          if (error || !profile) throw new Error('NISN tidak ditemukan');
          email = profile.email;
        }
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password: pwd });
        if (error) throw error;
        if (!data.user) throw new Error('Login gagal');
        await initializeMainApp(data.user);
        showToast('Berhasil masuk', 'success');
      } catch (err) {
        console.error(err);
        showToast(err.message || 'Gagal login', 'error');
      } finally { showLoading(false); }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('login-form').addEventListener('submit', handleLogin);
      document.getElementById('logout-button')?.addEventListener('click', async () => { await supabaseClient.auth.signOut(); location.reload(); });

      // session check
      try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session?.user) await initializeMainApp(session.user);
      } catch (e) { console.warn('Session check failed', e); }
    });
  </script>
</body>
</html>
